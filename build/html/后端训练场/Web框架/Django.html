<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Django &mdash; Liu圈圈的后宫 1.0.0 文档</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/translations.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="Django REST framework" href="Django%20REST%20framework.html" />
    <link rel="prev" title="Web框架" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> Liu圈圈的后宫
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">内容索引:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../%E8%BD%AF%E4%BB%B6%E6%B5%8B%E8%AF%95%E4%BD%93%E7%B3%BB%E7%9F%A5%E8%AF%86/index.html">软件测试体系知识</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Python%E7%AC%94%E8%AE%B0/index.html">Python笔记</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Linux%E7%AC%94%E8%AE%B0/index.html">Linux笔记</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/index.html">计算机网络</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Web%E5%AE%89%E5%85%A8/index.html">Web安全</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../%E6%95%B0%E6%8D%AE%E5%BA%93/index.html">数据库</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../%E5%BE%AE%E6%9C%8D%E5%8A%A1/index.html">微服务</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../%E5%89%8D%E7%AB%AF%E6%B8%B8%E4%B9%90%E5%9C%BA/index.html">前端游乐场</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">后端训练场</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Web框架</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Django</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">简介</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">项目搭建</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">项目配置</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id10">请求响应</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id11">类视图与中间件</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id12">模板</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id13">数据库</a></li>
<li class="toctree-l4"><a class="reference internal" href="#admin">admin站点</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="Django%20REST%20framework.html">Django REST framework</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97/index.html">任务队列</a></li>
<li class="toctree-l2"><a class="reference internal" href="../%E7%88%AC%E8%99%AB/index.html">爬虫</a></li>
<li class="toctree-l2"><a class="reference internal" href="../%E9%83%A8%E7%BD%B2/index.html">部署</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A5%E5%85%B7/index.html">自动化工具</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Docker/index.html">Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DevOps%E8%90%BD%E5%9C%B0%E7%AC%94%E8%AE%B0/index.html">DevOps落地笔记</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../%E7%9C%BC%E5%89%8D%E4%B8%80%E4%BA%AE%E7%9A%84%E9%93%BE%E6%8E%A5%E5%A4%87%E5%BF%98%E5%BD%95/index.html">眼前一亮的链接备忘录</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../%E4%BC%9A%E5%B8%A6%E5%9B%A2%E9%98%9F%E7%9A%84%E6%8A%80%E6%9C%AF%E4%BA%BA/index.html">会带团队的技术人</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../%E6%96%87%E6%A1%A3%E9%9B%86/index.html">文档集</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/index.html">环境搭建</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../%E5%9C%88%E5%9C%88%E7%A2%8E%E7%A2%8E%E5%BF%B5/index.html">圈圈碎碎念</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Liu圈圈的后宫</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">后端训练场</a> &raquo;</li>
          <li><a href="index.html">Web框架</a> &raquo;</li>
      <li>Django</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/后端训练场/Web框架/Django.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="django">
<h1>Django<a class="headerlink" href="#django" title="永久链接至标题">¶</a></h1>
<section id="id1">
<h2>简介<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<ul class="simple">
<li><p>用python语言写的开源web开发框架，并遵循MVC设计；</p></li>
<li><p>Django的主要目的是简便、快速的开发数据库驱动的网站；</p></li>
<li><p>它强调代码复用，多个组件可以很方便的以”插件”形式服务于整个框架；</p></li>
<li><p>Django有许多功能强大的第三方插件，你甚至可以很方便的开发出自己的工具包；</p></li>
<li><p>这使得Django具有很强的可扩展性；</p></li>
<li><p>它还强调快速开发和DRY(DoNotRepeatYourself)原则。</p></li>
</ul>
<section id="id2">
<h3>特点<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h3>
<ol class="simple">
<li><p>重量级框架</p>
<ul class="simple">
<li><p>对比Flask框架，Django原生提供了众多的功能组件，让开发更简便快速。</p>
<ul>
<li><p>提供项目工程管理的自动化脚本工具</p></li>
<li><p>数据库ORM支持（对象关系映射，英语：Object Relational Mapping）</p></li>
<li><p>模板</p></li>
<li><p>表单</p></li>
<li><p>Admin管理站点</p></li>
<li><p>文件管理</p></li>
<li><p>认证权限</p></li>
<li><p>session机制</p></li>
<li><p>缓存</p></li>
</ul>
</li>
</ul>
</li>
<li><p>MVT模式</p>
<ul class="simple">
<li><p>有一种程序设计模式叫MVC，其核心思想是分工、解耦，让不同的代码块之间降低耦合，增强代码的可扩展性和可移植性，实现向后兼容；</p>
<ul>
<li><p>M全拼为Model，主要封装对数据库层的访问，对数据库中的数据进行增、删、改、查操作；</p></li>
<li><p>V全拼为View，用于封装结果，生成页面展示的html内容；</p></li>
<li><p>C全拼为Controller，用于接收请求，处理业务逻辑，与Model和View交互，返回结果。</p></li>
</ul>
</li>
<li><p>Django的MVT</p>
<ul>
<li><p>M全拼为Model，与MVC中的M功能相同，负责和数据库交互，进行数据处理；</p></li>
<li><p>V全拼为View，与MVC中的C功能相同，接收请求，进行业务处理，返回应答；</p></li>
<li><p>T全拼为Template，与MVC中的V功能相同，负责封装构造要返回的html。</p></li>
</ul>
</li>
</ul>
</li>
</ol>
</section>
</section>
<section id="id3">
<h2>项目搭建<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<section id="id4">
<h3>环境安装<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h3>
<p>创建虚拟环境（不想创建你随意~）</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>pip3 install virtualenv
virtualenv venv
如果存在多个python解释器，可以选择指定一个Python解释器（比如python3.6）
virtualenv -p python3.6 venv
</pre></div>
</div>
<p>安装Django</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip3</span> <span class="n">install</span> <span class="n">Django</span>
</pre></div>
</div>
<p>Virtualenv相关命令总结：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>workon: 打印所有的虚拟环境；
mkvirtualenv xxx: 创建 xxx 虚拟环境，可以–python=/usr/bin/python3.6 指定python版本;
workon xxx: 使用 xxx 虚拟环境;
deactivate: 退出 xxx 虚拟环境；
rmvirtualenv xxx: 删除 xxx 虚拟环境。
lsvirtualenv : 列举所有的环境。
</pre></div>
</div>
</section>
<section id="id5">
<h3>创建项目<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h3>
<ol>
<li><p>创建项目</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">django</span><span class="o">-</span><span class="n">admin</span> <span class="n">startproject</span> <span class="n">project</span>
</pre></div>
</div>
</li>
<li><p>项目目录说明：</p>
<ul class="simple">
<li><p>与项目同名的目录，此处为xxx；</p></li>
<li><p>settings.py 是项目的整体配置文件；</p></li>
<li><p>urls.py 是项目的URL配置文件；</p></li>
<li><p>wsgi.py 是项目与WSGI兼容的Web服务器入口；</p></li>
<li><p>manage.py 是项目管理文件，通过它管理项目。</p></li>
</ul>
</li>
<li><p>启动本地服务</p>
<ul class="simple">
<li><p>django提供了一个纯python编写的轻量级web服务器</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>python manage.py runserver ip:port
或者
python manage.py runserver
可以不写IP和端口，默认IP是127.0.0.1，默认端口为8000
</pre></div>
</div>
</li>
</ol>
</section>
<section id="id6">
<h3>创建应用<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h3>
<ol>
<li><p>创建（子）应用</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">startapp</span> <span class="n">app</span>
</pre></div>
</div>
</li>
<li><p>子应用目录说明：</p>
<ul class="simple">
<li><p>admin.py 文件跟网站的后台管理站点配置相关。</p></li>
<li><p>apps.py 文件用于配置当前子应用的相关信息。</p></li>
<li><p>migrations 目录用于存放数据库迁移历史文件。</p></li>
<li><p>models.py 文件用户保存数据库模型类。</p></li>
<li><p>tests.py 文件用于开发测试用例，编写单元测试。</p></li>
<li><p>views.py 文件用于编写Web应用视图。</p></li>
</ul>
</li>
<li><p>注册子应用</p>
<ul class="simple">
<li><p>注册安装一个子应用的方法，即是将子应用的配置信息文件apps.py中的Config类添加到项目配置文件settings.py中INSTALLED_APPS列表中。</p></li>
</ul>
</li>
</ol>
</section>
<section id="id7">
<h3>创建视图<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h3>
<ol>
<li><p>创建</p>
<ul class="simple">
<li><p>进入创建的应用模块，在views.py中编写视图</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	index视图</span>
<span class="sd">	:param request: 包含了请求信息的请求对象</span>
<span class="sd">	:return: 响应对象</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;hello the world!&quot;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>说明：</p></li>
<li><p>视图函数的第一个传入参数必须定义，用于接收Django构造的包含了请求数据的HttpReqeust对象，通常名为request;</p></li>
<li><p>视图函数的返回值必须为一个响应对象，不能像Flask一样直接返回一个字符串，可以将要返回的字符串数据放到一个HTTPResponse对象中。</p></li>
</ul>
</li>
<li><p>定义路由URL</p>
<ul class="simple">
<li><p>进入创建的应用模块，在urls.py中保存应用路由</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span>	
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span>	
<span class="c1"># urlpatterns是被django自动识别的路由列表变量</span>
<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># 每个路由信息都需要使用url函数来构造</span>
    <span class="c1"># url(路径, 视图)</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^index/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">index</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
</div>
</li>
<li><p>在项目总路由project/urls.py中添加子应用的路由数据</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span><span class="p">,</span> <span class="n">include</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>	
<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^admin/&#39;</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>  <span class="c1"># django默认包含的	</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^app/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;app.urls&#39;</span><span class="p">)),</span> 
<span class="p">]</span>
</pre></div>
</div>
<ul class="simple">
<li><p>备注：</p></li>
<li><p>使用include来将子应用app里的全部路由包含进项目路由中；</p></li>
<li><p>r’^app/’ 决定了app子应用的所有路由都已/app/开头，如我们刚定义的视图index，其最终的完整访问路径为/app/index/；</p></li>
<li><p>include函数除了可以传递字符串之外，也可以直接传递应用的urls模块。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span><span class="p">,</span> <span class="n">include</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">import</span> <span class="nn">users.urls</span>  <span class="c1"># 先导入应用的urls模块	</span>
<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^admin/&#39;</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^users/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span>  <span class="c1"># 添加应用的路由</span>
<span class="p">]</span>
</pre></div>
</div>
</li>
</ol>
</section>
</section>
<section id="id8">
<h2>项目配置<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h2>
<section id="id9">
<h3>配置文件<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h3>
<ol>
<li><p>BASE_DIR</p>
<ul class="simple">
<li><p>当前工程的根目录，Django会依此来定位工程内的相关文件，我们也可以使用该参数来构造文件路径</p></li>
</ul>
</li>
<li><p>DEBUG</p>
<ul class="simple">
<li><p>调试模式，创建工程后初始值为True，即默认工作在调试模式下</p></li>
<li><p>Django程序出现异常时，向前端显示详细的错误追踪信息</p></li>
<li><p>部署线上运行的Django不要运行在调式模式下，记得修改DEBUG=False</p></li>
</ul>
</li>
<li><p>语言与时区</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LANGUAGE_CODE</span> <span class="o">=</span> <span class="s1">&#39;zh-hans&#39;</span>
<span class="n">TIME_ZONE</span> <span class="o">=</span> <span class="s1">&#39;Asia/Shanghai&#39;</span>
</pre></div>
</div>
</li>
<li><p>静态文件</p>
<ul class="simple">
<li><p>项目中的CSS、图片、js都是静态文件。一般会将静态文件放到一个单独的目录中，以方便管理；</p></li>
<li><p>静态文件可以放在项目根目录下，也可以放在应用的目录下，由于有些静态文件在项目中是通用的，所以推荐放在项目的根目录下，方便管理；</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">STATICFILES_DIRS</span><span class="o">=</span><span class="p">[]</span> <span class="n">存放查找静态文件的目录</span> <span class="n">接收的是list</span>
<span class="n">STATIC_URL</span> <span class="n">访问静态文件的URL前缀</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Django 仅在调试模式下（DEBUG=True）能对外提供静态文件；</p></li>
<li><p>当DEBUG=False工作在生产模式时，Django不再对外提供静态文件，需要是用collectstatic命令来收集静态文件并交由其他静态文件服务器来提供。</p></li>
</ul>
</li>
<li><p>路由说明</p>
<ul class="simple">
<li><p>Django的主要路由信息定义在工程同名目录下的urls.py文件中，该文件是Django解析路由的入口；</p></li>
<li><p>每个子应用为了保持相对独立，可以在各个子应用中定义属于自己的urls.py来保存该应用的路由，然后用主路由文件包含各应用的子路由数据。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">import</span> <span class="nn">app.views</span>
<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
	<span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^admin/&#39;</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>
	<span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^app/index/$&#39;</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="p">]</span>
</pre></div>
</div>
</li>
<li><p>路由解析顺序</p>
<ul class="simple">
<li><p>Django在接收到一个请求时，从主路由文件中的urlpatterns列表中以由上至下的顺序查找对应路由规则;</p></li>
<li><p>如果发现规则为include包含，则再进入被包含的urls中的urlpatterns列表由上至下进行查询;</p></li>
<li><p>值得关注的由上至下的顺序，有可能会使上面的路由屏蔽掉下面的路由，带来非预期结果。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
	<span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^say&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">say</span><span class="p">),</span>
	<span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^sayhello&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">sayhello</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
</div>
</li>
<li><p>路由命名与reverse反解析（逆向）</p>
<ul>
<li><p>在定义路由的时候，可以为路由命名，方便查找特定视图的具体路径信息；</p>
<ul>
<li><p>在使用include函数定义路由时，可以使用namespace参数定义路由的命名空间；</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^users/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;users.urls&#39;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;users&#39;</span><span class="p">)),</span>
</pre></div>
</div>
<ul class="simple">
<li><p>此命名空间表示，凡是users.urls中定义的路由，均属于namespace指明的users名下；</p></li>
<li><p>命名空间的作用是避免不同应用中的路由使用了相同的名字发生冲突，使用命名空间区别开。</p></li>
</ul>
</li>
<li><p>在定义普通路由（非include函数）时，可以使用name参数指明路由的名字；</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
	<span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^index/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">),</span>
	<span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^say&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">say</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;say&#39;</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>reverse反解析</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">reverse</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
	<span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;hello the world!&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">say</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
	<span class="n">url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;users:index&#39;</span><span class="p">)</span>  <span class="c1"># 返回 /users/index/</span>
	<span class="nb">print</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;say&#39;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>对于未指明namespace的，reverse(路由name)</p></li>
<li><p>对于指明namespace的，reverse(命名空间namespace:路由name)</p></li>
</ul>
</li>
</ul>
</li>
<li><p>路径结尾斜线/的说明</p>
<ul class="simple">
<li><p>Django中定义路由时，通常以斜线“/”结尾，其好处是用户访问不以斜线“/”结尾的相同路径时，Django会把用户重定向到以斜线“/”结尾的路径上，而不会返回404。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
	<span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^index/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
</div>
<ul class="simple">
<li><p>用户访问index或者index/网址，均能访问到index视图；</p></li>
<li><p>虽然路由结尾带/能带来上述好处，但是却违背了HTTP中URL表示资源位置路径的设计理念；</p></li>
<li><p>SO，是否结尾带“/”，你自己看着办！</p></li>
</ul>
</li>
</ol>
</section>
</section>
<section id="id10">
<h2>请求响应<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h2>
<section id="request">
<h3>请求Request<a class="headerlink" href="#request" title="永久链接至标题">¶</a></h3>
<ol>
<li><p>利用HTTP协议向服务器传参有几种途径？</p>
<ul class="simple">
<li><p>提取URL的特定部分，如/weather/beijing/2018，可以在服务器端的路由中用正则表达式截取；</p></li>
<li><p>查询字符串（query string)，形如key1=value1&amp;key2=value2；</p></li>
<li><p>请求体（body）中发送的数据，比如表单数据、json、xml；</p></li>
<li><p>在http报文的头（header）中。</p></li>
</ul>
</li>
<li><p>URL路径参数</p>
<ul class="simple">
<li><p>在定义路由URL时，可以使用正则表达式提取参数的方法从URL中获取请求参数，Django会将提取的参数直接传递到视图的传入参数中。</p></li>
<li><p>未命名参数按定义顺序传递</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^weather/([a-z]+)/(\d</span><span class="si">{4}</span><span class="s1">)/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">weather</span><span class="p">),</span>
<span class="k">def</span> <span class="nf">weather</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">city</span><span class="p">,</span> <span class="n">year</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;city=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">city</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;year=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">year</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;OK&#39;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>命名参数按名字传递</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^weather/(?P&lt;city&gt;[a-z]+)/(?P&lt;year&gt;\d</span><span class="si">{4}</span><span class="s1">)/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">weather</span><span class="p">),</span>
<span class="k">def</span> <span class="nf">weather</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">city</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;city=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">city</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;year=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">year</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;OK&#39;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Django中的QueryDict对象</p>
<ul>
<li><p>定义在django.http.QueryDict；</p></li>
<li><p>HttpRequest对象的属性GET、POST都是QueryDict类型的对象；</p></li>
<li><p>与python字典不同，QueryDict类型的对象用来处理同一个键带有多个值的情况；</p></li>
<li><p>方法get()：根据键获取值</p>
<ul class="simple">
<li><p>如果一个键同时拥有多个值将获取最后一个值</p></li>
<li><p>如果键不存在则返回None值，可以设置默认值进行后续处理</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;键&#39;</span><span class="p">,</span><span class="n">默认值</span><span class="p">)</span>
<span class="n">可简写为</span>
<span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;键&#39;</span><span class="p">]</span>
</pre></div>
</div>
</li>
<li><p>方法getlist()：根据键获取值，值以列表返回，可以获取指定键的所有值</p>
<ul class="simple">
<li><p>如果键不存在则返回空列表[]，可以设置默认值进行后续处理</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">dict</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;键&#39;</span><span class="p">,</span><span class="n">默认值</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>查询字符串Query String</p>
<ul class="simple">
<li><p>获取请求路径中的查询字符串参数（形如?k1=v1&amp;k2=v2），可以通过request.GET属性获取，返回QueryDict对象</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># /qs/?a=1&amp;b=2&amp;a=3</span>
<span class="k">def</span> <span class="nf">qs</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
	<span class="n">a</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
	<span class="n">b</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
	<span class="n">alist</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
	<span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>  <span class="c1"># 3</span>
	<span class="nb">print</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>  <span class="c1"># 2</span>
	<span class="nb">print</span><span class="p">(</span><span class="n">alist</span><span class="p">)</span>  <span class="c1"># [&#39;1&#39;, &#39;3&#39;]</span>
	<span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;OK&#39;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>查询字符串不区分请求方式，即假使客户端进行POST方式的请求，依然可以通过request.GET获取请求中的查询字符串数据。</p></li>
</ul>
</li>
<li><p>请求体</p>
<ul>
<li><p>请求体数据格式不固定，可以是表单类型字符串，可以是JSON字符串，可以是XML字符串，应区别对待；</p></li>
<li><p>可以发送请求体数据的请求方式有POST、PUT、PATCH、DELETE；</p></li>
<li><p>Django默认开启了CSRF防护，会对上述请求方式进行CSRF防护验证，在测试时可以关闭CSRF防护机制，方法为在settings.py文件中注释掉CSRF中间件。</p></li>
<li><p>表单类型 Form Data</p>
<ul class="simple">
<li><p>前端发送的表单类型的请求体数据，可以通过request.POST属性获取，返回QueryDict对象</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_body</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
	<span class="n">a</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
	<span class="n">b</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
	<span class="n">alist</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
	<span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
	<span class="nb">print</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
	<span class="nb">print</span><span class="p">(</span><span class="n">alist</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;OK&#39;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>request.POST只能用来获取POST方式的请求体表单数据</p></li>
</ul>
</li>
<li><p>非表单类型 Non-Form Data</p>
<ul class="simple">
<li><p>非表单类型的请求体数据，Django无法自动解析，可以通过request.body属性获取最原始的请求体数据；</p></li>
<li><p>自己按照请求体格式（JSON、XML等）进行解析；</p></li>
<li><p>request.body返回bytes类型。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>如请求体为JSON数据：{&quot;a&quot;: 1, &quot;b&quot;: 2}
import json	
def get_body_json(request):
	json_str = request.body
	json_str = json_str.decode()  # python3.6 无需执行此步
	req_data = json.loads(json_str)
	print(req_data[&#39;a&#39;])
	print(req_data[&#39;b&#39;])
	return HttpResponse(&#39;OK&#39;)
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>请求头</p>
<ul class="simple">
<li><p>可以通过request.META属性获取请求头headers中的数据，request.META为字典类型；</p></li>
<li><p>常见的请求头如：</p>
<ul>
<li><p>CONTENT_LENGTH – The length of the request body (as a string).</p></li>
<li><p>CONTENT_TYPE – The MIME type of the request body.</p></li>
<li><p>HTTP_ACCEPT – Acceptable content types for the response.</p></li>
<li><p>HTTP_ACCEPT_ENCODING – Acceptable encodings for the response.</p></li>
<li><p>HTTP_ACCEPT_LANGUAGE – Acceptable languages for the response.</p></li>
<li><p>HTTP_HOST – The HTTP Host header sent by the client.</p></li>
<li><p>HTTP_REFERER – The referring page, if any.</p></li>
<li><p>HTTP_USER_AGENT – The client’s user-agent string.</p></li>
<li><p>QUERY_STRING – The query string, as a single (unparsed) string.</p></li>
<li><p>REMOTE_ADDR – The IP address of the client.</p></li>
<li><p>REMOTE_HOST – The hostname of the client.</p></li>
<li><p>REMOTE_USER – The user authenticated by the Web server, if any.</p></li>
<li><p>REQUEST_METHOD – A string such as “GET” or “POST”.</p></li>
<li><p>SERVER_NAME – The hostname of the server.</p></li>
<li><p>SERVER_PORT – The port of the server (as a string).</p></li>
</ul>
</li>
<li><p>具体使用</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_headers</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
	<span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s1">&#39;CONTENT_TYPE&#39;</span><span class="p">])</span>
	<span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;OK&#39;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>其他常用HttpRequest对象属性</p>
<ul class="simple">
<li><p>method：一个字符串，表示请求使用的HTTP方法，常用值包括：’GET’、’POST’；</p></li>
<li><p>user：请求的用户对象；</p></li>
<li><p>path：一个字符串，表示请求的页面的完整路径，不包含域名和参数部分；</p></li>
<li><p>encoding：一个字符串，表示提交的数据的编码方式；</p>
<ul>
<li><p>如果为None则表示使用浏览器的默认设置，一般为utf-8；</p></li>
<li><p>这个属性是可写的，可以通过修改它来修改访问表单数据使用的编码，接下来对属性的任何访问将使用新的encoding值；</p></li>
</ul>
</li>
<li><p>FILES：一个类似于字典的对象，包含所有的上传文件。</p></li>
</ul>
</li>
</ol>
</section>
<section id="response">
<h3>响应Response<a class="headerlink" href="#response" title="永久链接至标题">¶</a></h3>
<ul class="simple">
<li><p>视图在接收请求并处理后，必须返回HttpResponse对象或子对象；</p></li>
<li><p>HttpRequest对象由Django创建，HttpResponse对象由开发人员创建。</p></li>
</ul>
<ol>
<li><p>HttpResponse</p>
<ul class="simple">
<li><p>可以使用django.http.HttpResponse来构造响应对象</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">HttpResponse</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">响应体</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="n">响应体数据类型</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">状态码</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>也可通过HttpResponse对象属性来设置响应体、状态码：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>content：表示返回的内容。
status_code：返回的HTTP响应状态码。
</pre></div>
</div>
<ul class="simple">
<li><p>响应头可以直接将HttpResponse对象当做字典进行响应头键值对的设置</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">()</span>
<span class="n">response</span><span class="p">[</span><span class="s1">&#39;xxx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Python&#39;</span>  <span class="c1"># 自定义响应头xxx, 值为Python</span>
</pre></div>
</div>
<ul class="simple">
<li><p>示例：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>
<span class="k">def</span> <span class="nf">demo_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
	<span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
	<span class="n">或者</span>
	<span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>
	<span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">400</span>
	<span class="n">response</span><span class="p">[</span><span class="s1">&#39;xxx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Python&#39;</span>
	<span class="k">return</span> <span class="n">response</span>
</pre></div>
</div>
</li>
<li><p>HttpResponse子类</p>
<ul class="simple">
<li><p>Django提供了一系列HttpResponse的子类，可以快速设置状态码</p>
<ul>
<li><p>HttpResponseRedirect 301</p></li>
<li><p>HttpResponsePermanentRedirect 302</p></li>
<li><p>HttpResponseNotModified 304</p></li>
<li><p>HttpResponseBadRequest 400</p></li>
<li><p>HttpResponseNotFound 404</p></li>
<li><p>HttpResponseForbidden 403</p></li>
<li><p>HttpResponseNotAllowed 405</p></li>
<li><p>HttpResponseGone 410</p></li>
<li><p>HttpResponseServerError 500</p></li>
</ul>
</li>
</ul>
</li>
<li><p>JsonResponse</p>
<ul>
<li><p>若要返回json数据，可以使用JsonResponse来构造响应对象，作用如下：</p>
<ul class="simple">
<li><p>帮助我们将数据转换为json字符串</p></li>
<li><p>设置响应头Content-Type为 application/json</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">JsonResponse</span>	
<span class="k">def</span> <span class="nf">demo_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
	<span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;city&#39;</span><span class="p">:</span> <span class="s1">&#39;chengdu&#39;</span><span class="p">,</span> <span class="s1">&#39;subject&#39;</span><span class="p">:</span> <span class="s1">&#39;python&#39;</span><span class="p">})</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>redirect重定向</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">redirect</span>
<span class="k">def</span> <span class="nf">demo_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
	<span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;/index.html&#39;</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="cookie">
<h3>Cookie<a class="headerlink" href="#cookie" title="永久链接至标题">¶</a></h3>
<ul class="simple">
<li><p>Cookie，有时也用其复数形式Cookies，指某些网站为了辨别用户身份、进行session跟踪而储存在用户本地终端上的数据（通常经过加密）；</p></li>
<li><p>Cookie是存储在浏览器中的一段纯文本信息，建议不要存储敏感信息如密码，因为电脑上的浏览器可能被其它人使用。</p></li>
<li><p>Cookie的特点：</p>
<ul>
<li><p>Cookie以键值对Key-Value形势进行信息的存储；</p></li>
<li><p>Cookie基于域名安全，不同域名的Cookie是不能互相访问的。</p></li>
</ul>
</li>
</ul>
<ol>
<li><p>设置Cookie</p>
<ul class="simple">
<li><p>可以通过HttpResponse对象中的set_cookie方法来设置cookie</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">HttpResponse</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="n">cookie名</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">cookie值</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="n">cookie有效期</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>max_age 单位为秒，默认为None；如果是临时cookie，可将max_age设置为None。</p></li>
</ul>
</li>
<li><p>读取Cookie</p>
<ul class="simple">
<li><p>可以通过HttpRequest对象的COOKIES属性来读取本次请求携带的cookie值；</p></li>
<li><p>request.COOKIES为字典类型。</p></li>
</ul>
</li>
</ol>
</section>
<section id="session">
<h3>Session<a class="headerlink" href="#session" title="永久链接至标题">¶</a></h3>
<ul class="simple">
<li><p>Session:在计算机中，尤其是在网络应用中，称为“会话控制”。Session 对象存储特定用户会话所需的属性及配置信息。这样，当用户在应用程序的 Web 页之间跳转时，存储在 Session 对象中的变量将不会丢失，而是在整个用户会话中一直存在下去。当用户请求来自应用程序的 Web 页时，如果该用户还没有会话，则 Web 服务器将自动创建一个 Session 对象。当会话过期或被放弃后，服务器将终止该会话。Session 对象最常见的一个用法就是存储用户的首选项。</p></li>
</ul>
<ol>
<li><p>Session 的作用</p>
<ul class="simple">
<li><p>Session 的作用就是它在 Web服务器上保持用户的状态信息供在任何时间从任何设备上的页面进行访问。因为浏览器不需要存储任何这种信息，所以可以使用任何浏览器，即使是像 Pad 或手机这样的浏览器设备。</p></li>
<li><p>保持会话状态!</p></li>
</ul>
</li>
<li><p>Session的特点</p>
<ul class="simple">
<li><p>依赖cookies</p></li>
<li><p>存储敏感、重要的信息</p></li>
<li><p>支持更多字节</p></li>
<li><p>Session共享问题</p></li>
</ul>
</li>
<li><p>Session配置和存储</p>
<ul>
<li><p>启用Session</p>
<ul class="simple">
<li><p>Django项目默认启用Session，可以在settings.py文件中查看</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MIDDLEWARE</span> <span class="o">=</span> <span class="p">[</span>
	<span class="o">...</span>
	<span class="s1">&#39;django.contrib.sessions.middleware.SessionMiddleware&#39;</span><span class="p">,</span>
	<span class="o">...</span>
<span class="p">]</span>
</pre></div>
</div>
<ul class="simple">
<li><p>如需禁用session，将上图中的session中间件注释掉即可</p></li>
</ul>
</li>
<li><p>存储方式</p>
<ul>
<li><p>在settings.py文件中，可以设置session数据的存储方式，可以保存在数据库、本地缓存等</p></li>
<li><p><strong>数据库</strong></p>
<ul class="simple">
<li><p>存储在数据库中，如下设置可以写，也可以不写，这是默认存储方式。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SESSION_ENGINE</span><span class="o">=</span><span class="s1">&#39;django.contrib.sessions.backends.db&#39;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>如果存储在数据库中，需要在项INSTALLED_APPS中安装Session应用。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
		<span class="o">...</span>
		<span class="s1">&#39;django.contrib.sessions&#39;</span>
		<span class="o">...</span>
<span class="p">]</span>
</pre></div>
</div>
<p>数据库中的表为：django_session，由表结构可知，操作Session包括三个数据：键，值，过期时间。</p>
</li>
<li><p><strong>本地缓存</strong></p>
<ul class="simple">
<li><p>存储在本机内存中，如果丢失则不能找回，比数据库的方式读写更快。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SESSION_ENGINE</span><span class="o">=</span><span class="s1">&#39;django.contrib.sessions.backends.cache&#39;</span>
</pre></div>
</div>
</li>
<li><p><strong>混合存储</strong></p>
<ul class="simple">
<li><p>优先从本机内存中存取，如果没有则从数据库中存取</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SESSION_ENGINE</span><span class="o">=</span><span class="s1">&#39;django.contrib.sessions.backends.cached_db&#39;</span>
</pre></div>
</div>
</li>
<li><p><strong>Redis</strong></p>
<ul>
<li><p>在redis中保存session，需要引入第三方扩展，我们可以使用django-redis来解决</p></li>
<li><p>安装</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">django</span><span class="o">-</span><span class="n">redis</span>
</pre></div>
</div>
<ul class="simple">
<li><p>配置</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CACHES</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="p">{</span>
		<span class="s2">&quot;BACKEND&quot;</span><span class="p">:</span> <span class="s2">&quot;django_redis.cache.RedisCache&quot;</span><span class="p">,</span>
		<span class="s2">&quot;LOCATION&quot;</span><span class="p">:</span> <span class="s2">&quot;redis://127.0.0.1:6379/1&quot;</span><span class="p">,</span>
		<span class="s2">&quot;OPTIONS&quot;</span><span class="p">:</span> <span class="p">{</span>
			<span class="s2">&quot;CLIENT_CLASS&quot;</span><span class="p">:</span> <span class="s2">&quot;django_redis.client.DefaultClient&quot;</span><span class="p">,</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">SESSION_ENGINE</span> <span class="o">=</span> <span class="s2">&quot;django.contrib.sessions.backends.cache&quot;</span>
<span class="n">SESSION_CACHE_ALIAS</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>如果redis的ip地址不是本地回环127.0.0.1，而是其他地址，访问Django时，可能出现Redis连接错误；</p></li>
<li><p>需修改redis的配置文件，添加特定ip地址。</p>
<ul>
<li><p>打开redis的配置文件</p></li>
<li><p>sudo vim /etc/redis/redis.conf</p></li>
<li><p>如要添加10.8.250.79地址，bind 127.0.0.1 10.8.250.79</p></li>
<li><p>sudo service redis-server restart</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Session操作</p></li>
</ol>
<ul>
<li><p>通过HttpRequest对象的session属性进行会话的读写操作。</p>
<ul class="simple">
<li><p>以键值对的格式写session</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;键&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">值</span>
</pre></div>
</div>
<ul class="simple">
<li><p>根据键读取值</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;键&#39;</span><span class="p">,</span><span class="n">默认值</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>清除所有session，在存储中删除值部分</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</pre></div>
</div>
<ul class="simple">
<li><p>清除session数据，在存储中删除session的整条数据</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</pre></div>
</div>
<ul class="simple">
<li><p>删除session中的指定键及值，在存储中只删除某个键及对应的值</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">del</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;键&#39;</span><span class="p">]</span>
</pre></div>
</div>
<ul class="simple">
<li><p>设置session的有效期</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">set_expiry</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>如果value是一个整数，session将在value秒没有活动后过期；</p></li>
<li><p>如果value为0，那么用户session的Cookie将在用户的浏览器关闭时过期；</p></li>
<li><p>如果value为None，那么session有效期将采用系统默认值，默认为两周，可以通过在settings.py中设置SESSION_COOKIE_AGE来设置全局默认值。</p></li>
</ul>
</li>
</ul>
</section>
</section>
<section id="id11">
<h2>类视图与中间件<a class="headerlink" href="#id11" title="永久链接至标题">¶</a></h2>
<ol>
<li><p>类视图</p>
<ul>
<li><p>引入</p>
<ul class="simple">
<li><p>以函数的方式定义的视图称为函数视图，函数视图便于理解；</p></li>
<li><p>但是遇到一个视图对应的路径提供了多种不同HTTP请求方式的支持时，便需要在一个函数中编写不同的业务逻辑，代码可读性与复用性都不佳。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;处理注册&quot;&quot;&quot;</span>
	<span class="c1"># 获取请求方法，判断是GET/POST请求</span>
	<span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
		<span class="c1"># 处理GET请求，返回注册页面</span>
		<span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;register.html&#39;</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="c1"># 处理POST请求，实现注册逻辑</span>
		<span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;这里实现注册逻辑&#39;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>使用类视图可以将视图对应的不同请求方式以类中的不同方法来区别定义</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.views.generic</span> <span class="kn">import</span> <span class="n">View</span>
<span class="k">class</span> <span class="nc">RegisterView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;类视图：处理注册&quot;&quot;&quot;</span>
	<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;处理GET请求，返回注册页面&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;register.html&#39;</span><span class="p">)</span>
	<span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;处理POST请求，实现注册逻辑&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;这里实现注册逻辑&#39;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>好处：</p>
<ul>
<li><p>代码可读性好</p></li>
<li><p>类视图相对于函数视图有更高的复用性， 如果其他地方需要用到某个类视图的某个特定逻辑，直接继承该类视图即可</p></li>
</ul>
</li>
</ul>
</li>
<li><p>使用</p>
<ul class="simple">
<li><p>定义类视图需要继承自Django提供的父类View；</p></li>
<li><p>可使用from django.views.generic import View或者from django.views.generic.base import View 导入，如上所示；</p></li>
<li><p>配置路由时，使用类视图的as_view()方法来添加。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
	<span class="c1"># 视图函数：注册</span>
	<span class="c1"># url(r&#39;^register/$&#39;, views.register, name=&#39;register&#39;),</span>
	<span class="c1"># 类视图：注册</span>
	<span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^register/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">RegisterView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;register&#39;</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
</div>
</li>
<li><p>原理</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="nd">@classonlymethod</span>
	<span class="k">def</span> <span class="nf">as_view</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">initkwargs</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Main entry point for a request-response process.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="o">...</span><span class="n">省略代码</span><span class="o">...</span>
		<span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
			<span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">initkwargs</span><span class="p">)</span>
			<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;get&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;head&#39;</span><span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">head</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
			<span class="c1"># 调用dispatch方法，按照不同请求方式调用不同请求方法</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
		<span class="o">...</span><span class="n">省略代码</span><span class="o">...</span>
		<span class="c1"># 返回真正的函数视图</span>
		<span class="k">return</span> <span class="n">view</span>
	<span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="c1"># Try to dispatch to the right method; if a method doesn&#39;t exist,</span>
		<span class="c1"># defer to the error handler. Also defer to the error handler if the</span>
		<span class="c1"># request method isn&#39;t on the approved list.</span>
		<span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_method_names</span><span class="p">:</span>
			<span class="n">handler</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_method_not_allowed</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_method_not_allowed</span>
		<span class="k">return</span> <span class="n">handler</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>调用流程 as_view–&gt;view–&gt;dispatch</p></li>
<li><p>getattr(’对象’,’字符串’)</p></li>
</ul>
</li>
<li><p>使用装饰器</p>
<ul>
<li><p>为了理解方便，先来定义一个为函数视图准备的装饰器（在设计装饰器时基本都以函数视图作为考虑的被装饰对象），及一个要被装饰的类视图。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
	<span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;自定义装饰器被调用了&#39;</span><span class="p">)</span>
		<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;请求路径</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">wrapper</span>
<span class="k">class</span> <span class="nc">DemoView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
	<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
		<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;get方法&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;ok&#39;</span><span class="p">)</span>
	<span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
		<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;post方法&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;ok&#39;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>在URL配置中装饰</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
	<span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^demo/$&#39;</span><span class="p">,</span> <span class="n">my_decorate</span><span class="p">(</span><span class="n">DemoView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()))</span>
<span class="p">]</span>
</pre></div>
</div>
<ul class="simple">
<li><p>此种方式最简单，但因装饰行为被放置到了url配置中，单看视图的时候无法知道此视图还被添加了装饰器，不利于代码的完整性，不建议使用。</p></li>
<li><p>此种方式会为类视图中的所有请求方法都加上装饰器行为（因为是在视图入口处，分发请求方式前）。</p></li>
</ul>
</li>
<li><p>在类视图中装饰</p>
<ul class="simple">
<li><p>在类视图中使用为函数视图准备的装饰器时，不能直接添加装饰器，需要使用method_decorator将其转换为适用于类视图方法的装饰器。</p></li>
<li><p>method_decorator装饰器使用name参数指明被装饰的方法</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 为全部请求方法添加装饰器</span>
<span class="nd">@method_decorator</span><span class="p">(</span><span class="n">my_decorator</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dispatch&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DemoView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
	<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
		<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;get方法&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;ok&#39;</span><span class="p">)</span>
	<span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
		<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;post方法&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;ok&#39;</span><span class="p">)</span>
<span class="c1"># 为特定请求方法添加装饰器</span>
<span class="nd">@method_decorator</span><span class="p">(</span><span class="n">my_decorator</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;get&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DemoView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
	<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
		<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;get方法&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;ok&#39;</span><span class="p">)</span>
	<span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
		<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;post方法&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;ok&#39;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>如果需要为类视图的多个方法添加装饰器，但又不是所有的方法（为所有方法添加装饰器参考上面例子），可以直接在需要添加装饰器的方法上使用method_decorator</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.utils.decorators</span> <span class="kn">import</span> <span class="n">method_decorator</span>
<span class="c1"># 为特定请求方法添加装饰器</span>
<span class="k">class</span> <span class="nc">DemoView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
	<span class="nd">@method_decorator</span><span class="p">(</span><span class="n">my_decorator</span><span class="p">)</span>  <span class="c1"># 为get方法添加了装饰器</span>
	<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
		<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;get方法&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;ok&#39;</span><span class="p">)</span>
	<span class="nd">@method_decorator</span><span class="p">(</span><span class="n">my_decorator</span><span class="p">)</span>  <span class="c1"># 为post方法添加了装饰器</span>
	<span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
		<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;post方法&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;ok&#39;</span><span class="p">)</span>
	<span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>  <span class="c1"># 没有为put方法添加装饰器</span>
		<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;put方法&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;ok&#39;</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>类视图Mixin扩展类</p>
<ul class="simple">
<li><p>使用面向对象多继承的特性，可以通过定义父类（作为扩展类），在父类中定义想要向类视图补充的方法，类视图继承这些扩展父类，便可实现代码复用。</p></li>
<li><p>定义的扩展父类名称通常以Mixin结尾</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyDecoratorMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
	<span class="nd">@classmethod</span>
	<span class="k">def</span> <span class="nf">as_view</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="n">view</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">as_view</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
		<span class="n">view</span> <span class="o">=</span> <span class="n">my_decorator</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">view</span>
<span class="k">class</span> <span class="nc">DemoView</span><span class="p">(</span><span class="n">MyDecoratorMixin</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>
	<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
		<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;get方法&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;ok&#39;</span><span class="p">)</span>
	<span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
		<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;post方法&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;ok&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ListModelMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	list扩展类</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="o">...</span>	
<span class="k">class</span> <span class="nc">CreateModelMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	create扩展类</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="o">...</span>
<span class="k">class</span> <span class="nc">BooksView</span><span class="p">(</span><span class="n">CreateModelMixin</span><span class="p">,</span> <span class="n">ListModelMixin</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	同时继承两个扩展类，复用list和create方法</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
		<span class="o">...</span>
	<span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
		<span class="o">...</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>中间件</p>
<ul>
<li><p>Django中的中间件是一个轻量级、底层的插件系统，可以介入Django的请求和响应处理过程，修改Django的输入或输出</p></li>
<li><p>中间件的设计为开发者提供了一种无侵入式的开发方式，增强了Django框架的健壮性。</p></li>
<li><p>我们可以使用中间件，在Django处理视图的不同阶段对输入或输出进行干预。</p></li>
<li><p>中间件的定义方法</p>
<ul class="simple">
<li><p>定义一个中间件工厂函数，然后返回一个可以被调用的中间件。</p></li>
<li><p>中间件工厂函数需要接收一个可以调用的get_response对象。</p></li>
<li><p>返回的中间件也是一个可以被调用的对象，并且像视图一样需要接收一个request对象参数，返回一个response对象。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">simple_middleware</span><span class="p">(</span><span class="n">get_response</span><span class="p">):</span>
	<span class="c1"># 此处编写的代码仅在Django第一次配置和初始化的时候执行一次。</span>
	<span class="k">def</span> <span class="nf">middleware</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
		<span class="c1"># 此处编写的代码会在每个请求处理视图前被调用。</span>
		<span class="n">response</span> <span class="o">=</span> <span class="n">get_response</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
		<span class="c1"># 此处编写的代码会在每个请求处理视图之后被调用。</span>
		<span class="k">return</span> <span class="n">response</span>
	<span class="k">return</span> <span class="n">middleware</span>
</pre></div>
</div>
<ul class="simple">
<li><p>例如，在users应用中新建一个middleware.py文件</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_middleware</span><span class="p">(</span><span class="n">get_response</span><span class="p">):</span>
	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;init 被调用&#39;</span><span class="p">)</span>
	<span class="k">def</span> <span class="nf">middleware</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
		<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;before request 被调用&#39;</span><span class="p">)</span>
		<span class="n">response</span> <span class="o">=</span> <span class="n">get_response</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
		<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;after response 被调用&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">response</span>
	<span class="k">return</span> <span class="n">middleware</span>
</pre></div>
</div>
<ul class="simple">
<li><p>定义好中间件后，需要在settings.py 文件中添加注册中间件</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MIDDLEWARE</span> <span class="o">=</span> <span class="p">[</span>
	<span class="s1">&#39;django.middleware.security.SecurityMiddleware&#39;</span><span class="p">,</span>
	<span class="s1">&#39;django.contrib.sessions.middleware.SessionMiddleware&#39;</span><span class="p">,</span>
	<span class="s1">&#39;django.middleware.common.CommonMiddleware&#39;</span><span class="p">,</span>
	<span class="s1">&#39;django.middleware.csrf.CsrfViewMiddleware&#39;</span><span class="p">,</span>
	<span class="s1">&#39;django.contrib.auth.middleware.AuthenticationMiddleware&#39;</span><span class="p">,</span>
	<span class="s1">&#39;django.contrib.messages.middleware.MessageMiddleware&#39;</span><span class="p">,</span>
	<span class="s1">&#39;django.middleware.clickjacking.XFrameOptionsMiddleware&#39;</span><span class="p">,</span>
	<span class="s1">&#39;users.middleware.my_middleware&#39;</span><span class="p">,</span>  <span class="c1"># 添加中间件</span>
<span class="p">]</span>
</pre></div>
</div>
<ul class="simple">
<li><p>定义一个视图进行测试</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">demo_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;view 视图被调用&#39;</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;OK&#39;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>备注：Django运行在调试模式下，中间件init部分有可能被调用两次</p></li>
<li><p>多个中间件的执行顺序</p>
<ul>
<li><p>在请求视图被处理前，中间件由上至下依次执行</p></li>
<li><p>在请求视图被处理后，中间件由下至上依次执行</p></li>
</ul>
</li>
<li><p>定义两个中间件</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_middleware</span><span class="p">(</span><span class="n">get_response</span><span class="p">):</span>
	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;init 被调用&#39;</span><span class="p">)</span>
	<span class="k">def</span> <span class="nf">middleware</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
		<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;before request 被调用&#39;</span><span class="p">)</span>
		<span class="n">response</span> <span class="o">=</span> <span class="n">get_response</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
		<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;after response 被调用&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">response</span>
	<span class="k">return</span> <span class="n">middleware</span>

<span class="k">def</span> <span class="nf">my_middleware2</span><span class="p">(</span><span class="n">get_response</span><span class="p">):</span>
	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;init2 被调用&#39;</span><span class="p">)</span>
	<span class="k">def</span> <span class="nf">middleware</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
		<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;before request 2 被调用&#39;</span><span class="p">)</span>
		<span class="n">response</span> <span class="o">=</span> <span class="n">get_response</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
		<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;after response 2 被调用&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">response</span>
	<span class="k">return</span> <span class="n">middleware</span>
</pre></div>
</div>
<ul class="simple">
<li><p>注册添加两个中间件</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MIDDLEWARE</span> <span class="o">=</span> <span class="p">[</span>
	<span class="s1">&#39;django.middleware.security.SecurityMiddleware&#39;</span><span class="p">,</span>
	<span class="s1">&#39;django.contrib.sessions.middleware.SessionMiddleware&#39;</span><span class="p">,</span>
	<span class="s1">&#39;django.middleware.common.CommonMiddleware&#39;</span><span class="p">,</span>
	<span class="s1">&#39;django.middleware.csrf.CsrfViewMiddleware&#39;</span><span class="p">,</span>
	<span class="s1">&#39;django.contrib.auth.middleware.AuthenticationMiddleware&#39;</span><span class="p">,</span>
	<span class="s1">&#39;django.contrib.messages.middleware.MessageMiddleware&#39;</span><span class="p">,</span>
	<span class="s1">&#39;django.middleware.clickjacking.XFrameOptionsMiddleware&#39;</span><span class="p">,</span>
	<span class="s1">&#39;users.middleware.my_middleware&#39;</span><span class="p">,</span>  <span class="c1"># 添加</span>
	<span class="s1">&#39;users.middleware.my_middleware2&#39;</span><span class="p">,</span>  <span class="c1"># 添加</span>
<span class="p">]</span>
</pre></div>
</div>
<ul class="simple">
<li><p>执行结果</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">init2</span> <span class="n">被调用</span>
<span class="n">init</span> <span class="n">被调用</span>
<span class="n">before</span> <span class="n">request</span> <span class="n">被调用</span>
<span class="n">before</span> <span class="n">request</span> <span class="mi">2</span> <span class="n">被调用</span>
<span class="n">view</span> <span class="n">视图被调用</span>
<span class="n">after</span> <span class="n">response</span> <span class="mi">2</span> <span class="n">被调用</span>
<span class="n">after</span> <span class="n">response</span> <span class="n">被调用</span>
</pre></div>
</div>
</li>
</ul>
</li>
</ol>
</section>
<section id="id12">
<h2>模板<a class="headerlink" href="#id12" title="永久链接至标题">¶</a></h2>
<ol>
<li><p>Django自带模板</p>
<ul>
<li><p>配置</p>
<ul class="simple">
<li><p>在工程中创建模板目录templates</p></li>
<li><p>在settings.py配置文件中修改TEMPLATES配置项的DIRS值</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TEMPLATES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s1">&#39;BACKEND&#39;</span><span class="p">:</span> <span class="s1">&#39;django.template.backends.django.DjangoTemplates&#39;</span><span class="p">,</span>
        <span class="s1">&#39;DIRS&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s1">&#39;templates&#39;</span><span class="p">)],</span>  <span class="c1"># 此处修改</span>
        <span class="s1">&#39;APP_DIRS&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;OPTIONS&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;context_processors&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">&#39;django.template.context_processors.debug&#39;</span><span class="p">,</span>
                <span class="s1">&#39;django.template.context_processors.request&#39;</span><span class="p">,</span>
                <span class="s1">&#39;django.contrib.auth.context_processors.auth&#39;</span><span class="p">,</span>
                <span class="s1">&#39;django.contrib.messages.context_processors.messages&#39;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>
</pre></div>
</div>
</li>
<li><p>定义模板</p>
<ul class="simple">
<li><p>在templates目录中新建一个模板文件，如index.html</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;title&gt;Title&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;{{ city }}&lt;/h1&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre></div>
</div>
</li>
<li><p>模板渲染</p>
<ul class="simple">
<li><p>Django提供了一个函数render实现模板渲染</p></li>
<li><p>render(request对象, 模板文件路径, 模板数据字典)</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;city&#39;</span><span class="p">:</span> <span class="s1">&#39;北京&#39;</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span><span class="n">context</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>模板语法</p>
<ul>
<li><p>模板变量</p>
<ul class="simple">
<li><p>变量名必须由字母、数字、下划线（不能以下划线开头）和点组成。</p></li>
<li><p>语法：{{变量}}</p></li>
<li><p>模板变量可以使python的内建类型，也可以是对象</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;city&#39;</span><span class="p">:</span> <span class="s1">&#39;北京&#39;</span><span class="p">,</span>
        <span class="s1">&#39;adict&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;西游记&#39;</span><span class="p">,</span>
            <span class="s1">&#39;author&#39;</span><span class="p">:</span> <span class="s1">&#39;吴承恩&#39;</span>
        <span class="p">},</span>
        <span class="s1">&#39;alist&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;index.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;title&gt;Title&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;{{ city }}&lt;/h1&gt;
    &lt;h1&gt;{{ adict }}&lt;/h1&gt;
    &lt;h1&gt;{{ adict.name }}&lt;/h1&gt;  注意字典的取值方法
    &lt;h1&gt;{{ alist }}&lt;/h1&gt;  
    &lt;h1&gt;{{ alist.0 }}&lt;/h1&gt;  注意列表的取值方法
&lt;/body&gt;
&lt;/html&gt;
</pre></div>
</div>
</li>
<li><p>模板语句</p>
<ul class="simple">
<li><p>for循环</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>{% for item in 列表 %}
循环逻辑
{{forloop.counter}}表示当前是第几次循环，从1开始
{%empty%} 列表为空或不存在时执行此逻辑
{% endfor %}
</pre></div>
</div>
<ul class="simple">
<li><p>if条件</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="o">...</span> <span class="o">%</span><span class="p">}</span>
<span class="n">逻辑1</span>
<span class="p">{</span><span class="o">%</span> <span class="k">elif</span> <span class="o">...</span> <span class="o">%</span><span class="p">}</span>
<span class="n">逻辑2</span>
<span class="p">{</span><span class="o">%</span> <span class="k">else</span> <span class="o">%</span><span class="p">}</span>
<span class="n">逻辑3</span>
<span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>比较运算符如：==、!=、&lt;、&gt;、&lt;=、&gt;=</p></li>
<li><p>布尔运算符如：and、or、not</p></li>
<li><p>运算符左右两侧不能紧挨变量或常量，必须有空格</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">%</span><span class="p">}</span>  <span class="c1"># 正确</span>
<span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="n">a</span><span class="o">==</span><span class="mi">1</span> <span class="o">%</span><span class="p">}</span>  <span class="c1"># 错误</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>过滤器</p>
<ul class="simple">
<li><p>使用管道符号|来应用过滤器，用于进行计算、转换操作，可以使用在变量、标签中。</p></li>
<li><p>如果过滤器需要参数，则使用冒号:传递参数。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">变量</span><span class="o">|</span><span class="n">过滤器</span><span class="p">:</span><span class="n">参数</span>
</pre></div>
</div>
<ul>
<li><p>列举几个自带过滤器</p>
<ul class="simple">
<li><p>safe，禁用转义，告诉模板这个变量是安全的，可以解释执行</p></li>
<li><p>length，长度，返回字符串包含字符的个数，或列表、元组、字典的元素个数。</p></li>
<li><p>default，默认值，如果变量不存在时则返回默认值。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">|</span><span class="n">default</span><span class="p">:</span><span class="s1">&#39;默认值&#39;</span>
</pre></div>
</div>
<ul>
<li><p>date，日期，用于对日期类型的值进行字符串格式化，常用的格式化字符如下</p>
<ul class="simple">
<li><p>Y表示年，格式为4位，y表示两位的年。</p></li>
<li><p>m表示月，格式为01,02,12等。</p></li>
<li><p>d表示日, 格式为01,02等。</p></li>
<li><p>j表示日，格式为1,2等。</p></li>
<li><p>H表示时，24进制，h表示12进制的时。</p></li>
<li><p>i表示分，为0-59。</p></li>
<li><p>s表示秒，为0-59。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">value</span><span class="o">|</span><span class="n">date</span><span class="p">:</span><span class="s2">&quot;Y年m月j日  H时i分s秒&quot;</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>template提供的内置过滤器，不够用，不灵活，就可以自己定义一个过滤器</p>
<ul class="simple">
<li><p>在自己的app里建一个templatetags包，在包里创建一个后面要在HTML文件引用的py文件，</p></li>
<li><p>在py文件中，先导入from django import template ，</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  实例化对象register = template.Library()
  创建一个template能认识的函数
  对创建的每一个过滤器，都要用加上装饰器

  #导入包
  from django import template
  #实例化注册对象
  register = template.Library()
  #使用装饰器自定义过滤器
  @register.filter
  def func(x):
	return x*x
</pre></div>
</div>
<ul class="simple">
<li><p>在HTML文件中引用</p>
<ul>
<li><p>load templatetags</p></li>
<li><p>使用过滤器</p></li>
</ul>
</li>
<li><p>注意点: templatetags文件夹 要在各自的应用内创建</p></li>
</ul>
</li>
</ul>
</li>
<li><p>模板继承</p>
<ul>
<li><p>模板继承和类的继承含义是一样的，主要是为了提高代码重用，减轻开发人员的工作量</p></li>
<li><p><strong>父模板</strong></p>
<ul class="simple">
<li><p>如果发现在多个模板中某些内容相同，那就应该把这段内容定义到父模板中。</p></li>
<li><p>标签block：用于在父模板中预留区域，留给子模板填充差异性的内容，名字不能相同。</p></li>
<li><p>为了更好的可读性，建议给endblock标签写上名字，这个名字与对应的block名字相同。</p></li>
<li><p>父模板中也可以使用上下文中传递过来的数据。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>{% block 名称 %}
预留区域，可以编写默认内容，也可以没有默认内容
{% endblock  名称 %}
</pre></div>
</div>
</li>
<li><p><strong>子模板</strong></p>
<ul class="simple">
<li><p>标签extends：继承，写在子模板文件的第一行</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="n">extends</span> <span class="s2">&quot;父模板路径&quot;</span><span class="o">%</span><span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>子模版不用填充父模版中的所有预留区域，如果子模版没有填充，则使用父模版定义的默认值。</p></li>
<li><p>填充父模板中指定名称的预留区域。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="n">block</span> <span class="n">名称</span> <span class="o">%</span><span class="p">}</span>
<span class="n">实际填充内容</span>
<span class="p">{{</span> <span class="n">block</span><span class="o">.</span><span class="n">super</span> <span class="p">}}</span><span class="n">用于获取父模板中block的内容</span>
<span class="p">{</span><span class="o">%</span> <span class="n">endblock</span> <span class="n">名称</span> <span class="o">%</span><span class="p">}</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>注释</p>
<ul class="simple">
<li><p>单行注释语法</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="c1">#...#}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>多行注释使用comment标签</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="n">comment</span> <span class="o">%</span><span class="p">}</span>
<span class="o">...</span>
<span class="p">{</span><span class="o">%</span> <span class="n">endcomment</span> <span class="o">%</span><span class="p">}</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>Jinja模板</p></li>
</ol>
<ul>
<li><p>Django中使用jinja2模板</p>
<ul class="simple">
<li><p>jinja2介绍</p>
<ul>
<li><p>是 Python 下一个被广泛应用的模板引擎，是由Python实现的模板语言</p></li>
<li><p>他的设计思想来源于 Django 的模板引擎，并扩展了其语法和一系列强大的功能，尤其是Flask框架内置的模板语言</p></li>
<li><p>由于django默认模板引擎功能不齐全,速度慢，所以我们也可以在Django中使用jinja2, jinja2宣称比django默认模板引擎快10-20倍。</p></li>
</ul>
</li>
<li><p>安装jinja2模块</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">jinja2</span>
</pre></div>
</div>
<ul>
<li><p>Django配置jinja2</p>
<ul class="simple">
<li><p>在项目文件中创建 jinja2_env.py 文件</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jinja2</span> <span class="kn">import</span> <span class="n">Environment</span>
<span class="k">def</span> <span class="nf">environment</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">):</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">env</span>
</pre></div>
</div>
<ul class="simple">
<li><p>在settings.py文件</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TEMPLATES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s1">&#39;BACKEND&#39;</span><span class="p">:</span> <span class="s1">&#39;django.template.backends.jinja2.Jinja2&#39;</span><span class="p">,</span><span class="c1">#修改1</span>
        <span class="s1">&#39;DIRS&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s1">&#39;templates&#39;</span><span class="p">)],</span>
        <span class="s1">&#39;APP_DIRS&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;OPTIONS&#39;</span><span class="p">:{</span>
            <span class="s1">&#39;environment&#39;</span><span class="p">:</span> <span class="s1">&#39;jinja2_env.environment&#39;</span><span class="p">,</span><span class="c1"># 修改2</span>
            <span class="s1">&#39;context_processors&#39;</span><span class="p">:[</span>
                <span class="s1">&#39;django.template.context_processors.debug&#39;</span><span class="p">,</span>
                <span class="s1">&#39;django.template.context_processors.request&#39;</span><span class="p">,</span>
                <span class="s1">&#39;django.contrib.auth.context_processors.auth&#39;</span><span class="p">,</span>
                <span class="s1">&#39;django.contrib.messages.context_processors.messages&#39;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>
</pre></div>
</div>
<ul>
<li><p>jinja2模板的使用绝大多数和Django自带模板一样</p>
<ul class="simple">
<li><p>for循环有差异</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>loop.index 当前循环迭代次数（从1开始）
loop.index() 当前循环迭代次数（从0开始）
loop.reindex 到循环结束需要迭代次数（从1开始）
loop.reindex（） 到循环结束需要迭代次数（从0开始）
loop.first 如果是第一次迭代，为True
loop.last 如果是最后一次迭代，为True
loop.length 序列中的项目数
loop.cycle 在一串序列期间取值的辅助函数
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>jinja2自定义过滤器</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jinja2</span> <span class="kn">import</span> <span class="n">Environment</span>
<span class="k">def</span> <span class="nf">environment</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">):</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">)</span>
    <span class="c1"># 2.将自定义的过滤器添加到 环境中</span>
    <span class="n">env</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="s1">&#39;do_listreverse&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">do_listreverse</span>
    <span class="k">return</span> <span class="n">env</span>
<span class="c1"># 1.自定义过滤器</span>
<span class="k">def</span> <span class="nf">do_listreverse</span><span class="p">(</span><span class="n">li</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">li</span> <span class="o">==</span> <span class="s2">&quot;B&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;哈哈&quot;</span>
</pre></div>
</div>
</li>
</ul>
<ol class="simple">
<li><p>CSRF攻击</p>
<ul class="simple">
<li><p>CSRF全拼为Cross Site Request Forgery，译为跨站请求伪造。</p></li>
<li><p>CSRF指攻击者盗用了你的身份，以你的名义发送恶意请求。</p></li>
<li><p>防止 CSRF 攻击</p>
<ul>
<li><p>在客户端向后端请求界面数据的时候，后端会往响应中的 cookie 中设置 csrf_token 的值</p></li>
<li><p>在 Form 表单中添加一个隐藏的的字段，值也是 csrf_token</p></li>
<li><p>在用户点击提交的时候，会带上这两个值向后台发起请求</p></li>
<li><p>后端接受到请求，以会以下几件事件：</p>
<ul>
<li><p>从 cookie中取出 csrf_token</p></li>
<li><p>从 表单数据中取出来隐藏的 csrf_token 的值</p></li>
<li><p>进行对比</p></li>
</ul>
</li>
<li><p>如果比较之后两值一样，那么代表是正常的请求，如果没取到或者比较不一样，代表不是正常的请求，不执行下一步操作</p></li>
</ul>
</li>
</ul>
</li>
</ol>
</section>
<section id="id13">
<h2>数据库<a class="headerlink" href="#id13" title="永久链接至标题">¶</a></h2>
<ol>
<li><p>ORM框架</p>
<ul class="simple">
<li><p>O是object，也就类对象的意思，R是relation，翻译成中文是关系，也就是关系数据库中数据表的意思，M是mapping，是映射的意思。在ORM框架中，它帮我们把类和数据表进行了一个映射，可以让我们通过类和类对象就能操作它所对应的表格中的数据。ORM框架还有一个功能，它可以根据我们设计的类自动帮我们生成数据库中的表格，省去了我们自己建表的过程。</p></li>
<li><p>django中内嵌了ORM框架，不需要直接面向数据库编程，而是定义模型类，通过模型类和对象完成数据表的增删改查操作。</p></li>
<li><p>使用django进行数据库开发的步骤如下：</p>
<ul>
<li><p>配置数据库连接信息</p></li>
<li><p>在models.py中定义模型类</p></li>
<li><p>迁移</p></li>
<li><p>通过类和对象完成数据增删改查操作</p></li>
</ul>
</li>
</ul>
</li>
<li><p>配置</p>
<ul class="simple">
<li><p>在settings.py中保存了数据库的连接配置信息，Django默认初始配置使用sqlite数据库</p></li>
<li><p>使用MySQL数据库首先需要安装驱动程序</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">PyMySQL</span>
</pre></div>
</div>
<ul class="simple">
<li><p>在Django的工程同名子目录的__init__.py文件中添加如下语句</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pymysql</span> <span class="kn">import</span> <span class="n">install_as_MySQLdb</span>
<span class="n">install_as_MySQLdb</span><span class="p">()</span>
<span class="n">作用是让Django的ORM能以mysqldb的方式来调用PyMySQ</span>
</pre></div>
</div>
<ul class="simple">
<li><p>修改DATABASES配置信息</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;ENGINE&#39;</span><span class="p">:</span> <span class="s1">&#39;django.db.backends.mysql&#39;</span><span class="p">,</span>
        <span class="s1">&#39;HOST&#39;</span><span class="p">:</span> <span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span>  <span class="c1"># 数据库主机</span>
        <span class="s1">&#39;PORT&#39;</span><span class="p">:</span> <span class="mi">3306</span><span class="p">,</span>  <span class="c1"># 数据库端口</span>
        <span class="s1">&#39;USER&#39;</span><span class="p">:</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span>  <span class="c1"># 数据库用户名</span>
        <span class="s1">&#39;PASSWORD&#39;</span><span class="p">:</span> <span class="s1">&#39;mysql&#39;</span><span class="p">,</span>  <span class="c1"># 数据库用户密码</span>
        <span class="s1">&#39;NAME&#39;</span><span class="p">:</span> <span class="s1">&#39;django_demo&#39;</span>  <span class="c1"># 数据库名字</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>在MySQL中创建数据库</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">create</span> <span class="n">database</span> <span class="n">django_demo</span> <span class="n">default</span> <span class="n">charset</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p>定义模型类</p>
<ul>
<li><p>模型类被定义在”应用/models.py”文件中。</p></li>
<li><p>模型类必须继承自Model类，位于包django.db.models中。</p></li>
<li><p>定义</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>创建应用booktest，在models.py 文件中定义模型类

from django.db import models
#定义图书模型类BookInfo
class BookInfo(models.Model):
	btitle = models.CharField(max_length=20, verbose_name=&#39;名称&#39;)
	bpub_date = models.DateField(verbose_name=&#39;发布日期&#39;)
	bread = models.IntegerField(default=0, verbose_name=&#39;阅读量&#39;)
	bcomment = models.IntegerField(default=0, verbose_name=&#39;评论量&#39;)
	is_delete = models.BooleanField(default=False, verbose_name=&#39;逻辑删除&#39;)
	class Meta:
		db_table = &#39;tb_books&#39;  # 指明数据库表名
		verbose_name = &#39;图书&#39;  # 在admin站点中显示的名称
		verbose_name_plural = verbose_name  # 显示的复数名称
	def __str__(self):
		&quot;&quot;&quot;定义每个数据对象的显示信息&quot;&quot;&quot;
		return self.btitle
#定义英雄模型类HeroInfo
class HeroInfo(models.Model):
	GENDER_CHOICES = (
		(0, &#39;female&#39;),
		(1, &#39;male&#39;)
	)
	hname = models.CharField(max_length=20, verbose_name=&#39;名称&#39;) 
	hgender = models.SmallIntegerField(choices=GENDER_CHOICES, default=0, verbose_name=&#39;性别&#39;)  
	hcomment = models.CharField(max_length=200, null=True, verbose_name=&#39;描述信息&#39;) 
	hbook = models.ForeignKey(BookInfo, on_delete=models.CASCADE, verbose_name=&#39;图书&#39;)  # 外键
	is_delete = models.BooleanField(default=False, verbose_name=&#39;逻辑删除&#39;)
	class Meta:
		db_table = &#39;tb_heros&#39;
		verbose_name = &#39;英雄&#39;
		verbose_name_plural = verbose_name
	def __str__(self):
		return self.hname
</pre></div>
</div>
</li>
<li><p>数据库表名</p>
<ul class="simple">
<li><p>模型类如果未指明表名，Django默认以 小写app应用名_小写模型类名 为数据库表名。</p></li>
<li><p>可通过db_table 指明数据库表名。</p></li>
</ul>
</li>
<li><p>关于主键</p>
<ul class="simple">
<li><p>django会为表创建自动增长的主键列，每个模型只能有一个主键列，如果使用选项设置某属性为主键列后django不会再创建自动增长的主键列。</p></li>
<li><p>默认创建的主键列属性为id，可以使用pk代替，pk全拼为primary key。</p></li>
</ul>
</li>
<li><p>属性命名限制</p>
<ul class="simple">
<li><p>不能是python的保留关键字。</p></li>
<li><p>不允许使用连续的下划线，这是由django的查询方式决定的。</p></li>
<li><p>定义属性时需要指定字段类型，通过字段类型的参数指定选项，语法如下：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">属性</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">字段类型</span><span class="p">(</span><span class="n">选项</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>字段类型</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>|AutoField	|自动增长的IntegerField，通常不用指定，不指定时Django会自动创建属性名为id的自动增长属性|
|BooleanField	|布尔字段，值为True或False|
|NullBooleanField	|支持Null、True、False三种值|
|CharField	|字符串，参数max_length表示最大字符个数|
|TextField	|大文本字段，一般超过4000个字符时使用|
|IntegerField	|整数|
|DecimalField	|十进制浮点数， 参数max_digits表示总位数， 参数decimal_places表示小数位数|
|FloatField	|浮点数|
|DateField	|日期， 参数auto_now表示每次保存对象时，自动设置该字段为当前时间，用于&quot;最后一次修改&quot;的时间戳，它总是使用当前日期，默认为False； 参数auto_now_add表示当对象第一次被创建时自动设置当前时间，用于创建的时间戳，它总是使用当前日期，默认为False; 参数auto_now_add和auto_now是相互排斥的，组合将会发生错误|
|TimeField	|时间，参数同DateField|
|DateTimeField	|日期时间，参数同DateField|
|FileField	|上传文件字段|
|ImageField	|继承于FileField，对上传的内容进行校验，确保是有效的图片|
</pre></div>
</div>
<ul class="simple">
<li><p>选项</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>|null		|如果为True，表示允许为空，默认值是False											|
|blank		|如果为True，则该字段允许为空白，默认值是False										|
|db_column	|字段的名称，如果未指定，则使用属性的名称											|
|db_index	|若值为True, 则在表中会为此字段创建索引，默认值是False								|
|default	|默认																				|
|primary_key|若为True，则该字段会成为模型的主键字段，默认值是False，一般作为AutoField的选项使用	|
|unique		|如果为True, 这个字段在表中必须有唯一值，默认值是False								|
null是数据库范畴的概念，blank是表单验证范畴的
</pre></div>
</div>
<ul>
<li><p>外键</p>
<ul class="simple">
<li><p>在设置外键时，需要通过on_delete选项指明主表删除数据时，对于外键引用表数据如何处理，在django.db.models中包含了可选常量：</p></li>
<li><p>CASCADE 级联，删除主表数据时连通一起删除外键表中数据</p></li>
<li><p>PROTECT 保护，通过抛出ProtectedError异常，来阻止删除主表中被外键应用的数据</p></li>
<li><p>SET_NULL 设置为NULL，仅在该字段null=True允许为null时可用</p></li>
<li><p>SET_DEFAULT 设置为默认值，仅在该字段设置了默认值时可用</p></li>
<li><p>SET() 设置为特定值或者调用特定方法，如</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="kn">import</span> <span class="n">get_user_model</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>

<span class="k">def</span> <span class="nf">get_sentinel_user</span><span class="p">():</span>
	<span class="k">return</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;deleted&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
	<span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
		<span class="n">settings</span><span class="o">.</span><span class="n">AUTH_USER_MODEL</span><span class="p">,</span>
		<span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">SET</span><span class="p">(</span><span class="n">get_sentinel_user</span><span class="p">),</span>
	<span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>DO_NOTHING 不做任何操作，如果数据库前置指明级联性，此选项会抛出IntegrityError异常</p></li>
</ul>
</li>
</ul>
</li>
<li><p>迁移</p>
<ul class="simple">
<li><p>将模型类同步到数据库中</p></li>
<li><p>生成迁移文件</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">makemigrations</span>
</pre></div>
</div>
<ul class="simple">
<li><p>同步到数据库中</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">migrate</span>
</pre></div>
</div>
</li>
<li><p>添加测试数据</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">insert</span> <span class="n">into</span> <span class="n">tb_books</span><span class="p">(</span><span class="n">btitle</span><span class="p">,</span><span class="n">bpub_date</span><span class="p">,</span><span class="n">bread</span><span class="p">,</span><span class="n">bcomment</span><span class="p">,</span><span class="n">is_delete</span><span class="p">)</span> <span class="n">values</span>
<span class="p">(</span><span class="s1">&#39;射雕英雄传&#39;</span><span class="p">,</span><span class="s1">&#39;1980-5-1&#39;</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">34</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;天龙八部&#39;</span><span class="p">,</span><span class="s1">&#39;1986-7-24&#39;</span><span class="p">,</span><span class="mi">36</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;笑傲江湖&#39;</span><span class="p">,</span><span class="s1">&#39;1995-12-24&#39;</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;雪山飞狐&#39;</span><span class="p">,</span><span class="s1">&#39;1987-11-11&#39;</span><span class="p">,</span><span class="mi">58</span><span class="p">,</span><span class="mi">24</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">insert</span> <span class="n">into</span> <span class="n">tb_heros</span><span class="p">(</span><span class="n">hname</span><span class="p">,</span><span class="n">hgender</span><span class="p">,</span><span class="n">hbook_id</span><span class="p">,</span><span class="n">hcomment</span><span class="p">,</span><span class="n">is_delete</span><span class="p">)</span> <span class="n">values</span>
<span class="p">(</span><span class="s1">&#39;郭靖&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;降龙十八掌&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;黄蓉&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;打狗棍法&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;黄药师&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;弹指神通&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;欧阳锋&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;蛤蟆功&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;梅超风&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;九阴白骨爪&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;乔峰&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;降龙十八掌&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;段誉&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;六脉神剑&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;虚竹&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;天山六阳掌&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;王语嫣&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;神仙姐姐&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;令狐冲&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="s1">&#39;独孤九剑&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;任盈盈&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="s1">&#39;弹琴&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;岳不群&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="s1">&#39;华山剑法&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;东方不败&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="s1">&#39;葵花宝典&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;胡斐&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="s1">&#39;胡家刀法&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;苗若兰&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="s1">&#39;黄衣&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;程灵素&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="s1">&#39;医术&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;袁紫衣&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="s1">&#39;六合拳&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>演示工具使用</p>
<ul class="simple">
<li><p>Django的manage工具提供了shell命令，帮助我们配置好当前工程的运行环境（如连接好数据库等），以便可以直接在终端中执行测试python语句</p></li>
<li><p>通过如下命令进入shell</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">shell</span>
</pre></div>
</div>
<ul class="simple">
<li><p>导入两个模型类，以便后续使用</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">booktest.models</span> <span class="kn">import</span> <span class="n">BookInfo</span><span class="p">,</span> <span class="n">HeroInfo</span>
</pre></div>
</div>
</li>
<li><p>查看MySQL数据库日志</p>
<ul class="simple">
<li><p>查看mysql数据库日志可以查看对数据库的操作记录。 mysql日志文件默认没有产生，需要做如下配置</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">mysql</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">mysqld</span><span class="o">.</span><span class="n">cnf</span>
<span class="n">将general_log_file和general_log两处注释取消</span>
<span class="n">sudo</span> <span class="n">service</span> <span class="n">mysql</span> <span class="n">restart</span>
<span class="n">tail</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">mysql</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
</li>
<li><p>数据库操作</p>
<ul>
<li><p>增加(2种方式)</p>
<ul>
<li><p>save</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="n">book</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="p">(</span>
	<span class="n">btitle</span><span class="o">=</span><span class="s1">&#39;西游记&#39;</span><span class="p">,</span>
	<span class="n">bpub_date</span><span class="o">=</span><span class="n">date</span><span class="p">(</span><span class="mi">1988</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
	<span class="n">bread</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
	<span class="n">bcomment</span><span class="o">=</span><span class="mi">10</span>
<span class="p">)</span>
<span class="n">book</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="n">hero</span> <span class="o">=</span> <span class="n">HeroInfo</span><span class="p">(</span>
	<span class="n">hname</span><span class="o">=</span><span class="s1">&#39;孙悟空&#39;</span><span class="p">,</span>
	<span class="n">hgender</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
	<span class="n">hbook</span><span class="o">=</span><span class="n">book</span>
<span class="p">)</span>
<span class="n">hero</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="n">hero2</span> <span class="o">=</span> <span class="n">HeroInfo</span><span class="p">(</span>
	<span class="n">hname</span><span class="o">=</span><span class="s1">&#39;猪八戒&#39;</span><span class="p">,</span>
	<span class="n">hgender</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
	<span class="n">hbook_id</span><span class="o">=</span><span class="n">book</span><span class="o">.</span><span class="n">id</span>
<span class="p">)</span>
<span class="n">hero2</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p>create</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">模型类</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>

<span class="n">HeroInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
    <span class="n">hname</span><span class="o">=</span><span class="s1">&#39;沙悟净&#39;</span><span class="p">,</span>
    <span class="n">hgender</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">hbook</span><span class="o">=</span><span class="n">book</span>
<span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>删除(2种方式)</p>
<ul class="simple">
<li><p>模型类对象delete</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">hero</span> <span class="o">=</span> <span class="n">HeroInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
<span class="n">hero</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</pre></div>
</div>
<ul class="simple">
<li><p>模型类.objects.filter().delete()</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">HeroInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p>修改(2种方式)</p>
<ul class="simple">
<li><p>save</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>修改模型类对象的属性，然后执行save()方法

hero = HeroInfo.objects.get(hname=&#39;猪八戒&#39;)
hero.hname = &#39;猪悟能&#39;
hero.save()
</pre></div>
</div>
<ul class="simple">
<li><p>update</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>使用模型类.objects.filter().update()，会返回受影响的行数

HeroInfo.objects.filter(hname=&#39;沙悟净&#39;).update(hname=&#39;沙僧&#39;)
</pre></div>
</div>
</li>
<li><p>查询</p>
<ul>
<li><p>基本查询</p>
<ul class="simple">
<li><p>get 查询单一结果，如果不存在会抛出模型类.DoesNotExist异常。</p></li>
<li><p>all 查询多个结果。</p></li>
<li><p>count 查询结果数量。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">BookInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="o">&lt;</span><span class="n">QuerySet</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">BookInfo</span><span class="p">:</span> <span class="n">射雕英雄传</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">BookInfo</span><span class="p">:</span> <span class="n">天龙八部</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">BookInfo</span><span class="p">:</span> <span class="n">笑傲江湖</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">BookInfo</span><span class="p">:</span> <span class="n">雪山飞狐</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">BookInfo</span><span class="p">:</span> <span class="n">西游记</span><span class="o">&gt;</span><span class="p">]</span><span class="o">&gt;</span>
<span class="n">book</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">btitle</span><span class="o">=</span><span class="s1">&#39;西游记&#39;</span><span class="p">)</span>
<span class="n">book</span><span class="o">.</span><span class="n">id</span>
<span class="n">BookInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">BookInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">BookInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span> <span class="c1">#报错，没那么多数据		</span>
<span class="n">BookInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p>过滤查询</p>
<ul class="simple">
<li><p>filter 过滤出多个结果</p></li>
<li><p>exclude 排除掉符合条件剩下的结果</p></li>
<li><p>get 过滤单一结果</p></li>
<li><p>对于过滤条件的使用，上述三个方法相同，故仅以filter进行讲解</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>语法：
属性名称__比较运算符=值
# 属性名称和比较运算符间使用两个下划线，所以属性名不能包括多个下划线
</pre></div>
</div>
<ul>
<li><p>相等</p>
<ul class="simple">
<li><p>exact：表示判等</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>BookInfo.objects.filter(id__exact=1)
可简写为：
BookInfo.objects.filter(id=1)
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>模糊查询</p>
<ul class="simple">
<li><p>contains：是否包含，如果要包含%无需转义，直接写即可</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>查询书名包含&#39;传&#39;的图书。

BookInfo.objects.filter(btitle__contains=&#39;传&#39;)
</pre></div>
</div>
<ul class="simple">
<li><p>startswith、endswith：以指定值开头或结尾</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">查询书名以</span><span class="s1">&#39;部&#39;</span><span class="n">结尾的图书</span>

<span class="n">BookInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">btitle__endswith</span><span class="o">=</span><span class="s1">&#39;部&#39;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>以上运算符都区分大小写，在这些运算符前加上i表示不区分大小写，如iexact、icontains、istartswith、iendswith</p></li>
</ul>
</li>
<li><p>空查询</p>
<ul class="simple">
<li><p>isnull：是否为null</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>查询书名不为空的图书。

BookInfo.objects.filter(btitle__isnull=False)
</pre></div>
</div>
</li>
<li><p>范围查询</p>
<ul class="simple">
<li><p>in：是否包含在范围内。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>例：查询编号为1或3或5的图书
BookInfo.objects.filter(id__in=[1, 3, 5])
</pre></div>
</div>
</li>
<li><p>比较查询</p>
<ul class="simple">
<li><p>gt 大于 (greater then)</p></li>
<li><p>gte 大于等于 (greater then equal)</p></li>
<li><p>lt 小于 (less then)</p></li>
<li><p>lte 小于等于 (less then equal)</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">查询编号大于3的图书</span>

<span class="n">BookInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__gt</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>不等于的运算符，使用exclude()过滤器</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">查询编号不等于3的图书</span>

<span class="n">BookInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>日期查询</p>
<ul class="simple">
<li><p>year、month、day、week_day、hour、minute、second：对日期时间类型的属性进行运算</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>查询1980年发表的图书。
BookInfo.objects.filter(bpub_date__year=1980)
查询1980年1月1日后发表的图书。
BookInfo.objects.filter(bpub_date__gt=date(19	90, 1, 1))
</pre></div>
</div>
</li>
<li><p>F对象</p>
<ul class="simple">
<li><p>之前的查询都是对象的属性与常量值比较，两个属性怎么比较呢？ 答：使用F对象，被定义在django.db.models中。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>语法如下：
F(属性名)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>查询阅读量大于等于评论量的图书。
from django.db.models import F
BookInfo.objects.filter(bread__gte=F(&#39;bcomment&#39;))
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>可以在F对象上使用算数运算。
例：查询阅读量大于2倍评论量的图书。
BookInfo.objects.filter(bread__gt=F(&#39;bcomment&#39;) * 2)
</pre></div>
</div>
</li>
<li><p>Q对象</p>
<ul class="simple">
<li><p>多个过滤器逐个调用表示逻辑与关系，同sql语句中where部分的and关键字</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>查询阅读量大于20，并且编号小于3的图书。
BookInfo.objects.filter(bread__gt=20,id__lt=3)
或
BookInfo.objects.filter(bread__gt=20).filter(id__lt=3)
</pre></div>
</div>
<ul class="simple">
<li><p>如果需要实现逻辑或or的查询，需要使用Q()对象结合|运算符，Q对象被义在django.db.models</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>语法如下：
Q(属性名__运算符=值)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>查询阅读量大于20的图书，改写为Q对象如下。
from django.db.models import Q
BookInfo.objects.filter(Q(bread__gt=20))
</pre></div>
</div>
<ul class="simple">
<li><p>Q对象可以使用&amp;、|连接，&amp;表示逻辑与，|表示逻辑或。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>查询阅读量大于20，或编号小于3的图书，只能使用Q对象实现
BookInfo.objects.filter(Q(bread__gt=20) | Q(pk__lt=3))
</pre></div>
</div>
<ul class="simple">
<li><p>Q对象前可以使用~操作符，表示非not。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>查询编号不等于3的图书。
BookInfo.objects.filter(~Q(pk=3))
</pre></div>
</div>
</li>
<li><p>聚合函数</p>
<ul class="simple">
<li><p>使用aggregate()过滤器调用聚合函数。聚合函数包括：Avg 平均，Count 数量，Max 最大，Min 最小，Sum 求和，被定义在django.db.models中</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>查询图书的总阅读量。
from django.db.models import Sum
BookInfo.objects.aggregate(Sum(&#39;bread&#39;))
注意aggregate的返回值是一个字典类型，格式如下：
{&#39;属性名__聚合类小写&#39;:值}
如:{&#39;bread__sum&#39;:3}

使用count时一般不使用aggregate()过滤器
查询图书总数。
BookInfo.objects.count()
注意count函数的返回值是一个数字。
</pre></div>
</div>
</li>
<li><p>排序</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">使用order_by对结果进行排序</span>

<span class="n">BookInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;bread&#39;</span><span class="p">)</span>  <span class="c1"># 升序</span>
<span class="n">BookInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-bread&#39;</span><span class="p">)</span>  <span class="c1"># 降序</span>
</pre></div>
</div>
</li>
<li><p>关联查询</p>
<ul class="simple">
<li><p>由一到多的访问语法</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>一对多的模型类对象.多对应的模型类名小写_set 例：
b = BookInfo.objects.get(id=1)
b.heroinfo_set.all()
</pre></div>
</div>
<ul class="simple">
<li><p>由多到一的访问语法</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>多对一的模型类对象.多对应的模型类中的关系类属性名 例：
h = HeroInfo.objects.get(id=1)
h.hbook
</pre></div>
</div>
<ul class="simple">
<li><p>访问一对应的模型类关联对象的id语法</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">多对应的模型类对象</span><span class="o">.</span><span class="n">关联类属性_id</span>
<span class="n">h</span> <span class="o">=</span> <span class="n">HeroInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">h</span><span class="o">.</span><span class="n">hbook_id</span>
</pre></div>
</div>
</li>
<li><p>关联过滤查询</p>
<ul class="simple">
<li><p>由多模型类条件查询一模型类数据:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>语法如下：
关联模型类名小写__属性名__条件运算符=值
</pre></div>
</div>
<ul class="simple">
<li><p>注意：如果没有”__运算符”部分，表示等于。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>例：查询图书，要求图书英雄为&quot;孙悟空&quot;
BookInfo.objects.filter(heroinfo__hname=&#39;孙悟空&#39;)
查询图书，要求图书中英雄的描述包含&quot;八&quot;
BookInfo.objects.filter(heroinfo__hcomment__contains=&#39;八&#39;)
</pre></div>
</div>
<ul class="simple">
<li><p>由一模型类条件查询多模型类数据:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>语法如下：
一模型类关联属性名__一模型类属性名__条件运算符=值
</pre></div>
</div>
<ul class="simple">
<li><p>注意：如果没有”__运算符”部分，表示等于。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>例：查询书名为“天龙八部”的所有英雄。
HeroInfo.objects.filter(hbook__btitle=&#39;天龙八部&#39;)
查询图书阅读量大于30的所有英雄
HeroInfo.objects.filter(hbook__bread__gt=30)
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
</li>
<li><p>查询集 QuerySet</p>
<ul>
<li><p>概念</p>
<ul class="simple">
<li><p>Django的ORM中存在查询集的概念。</p></li>
<li><p>查询集，也称查询结果集、QuerySet，表示从数据库中获取的对象集合。</p></li>
<li><p>当调用如下过滤器方法时，Django会返回查询集（而不是简单的列表）：</p>
<ul>
<li><p>all()：返回所有数据。</p></li>
<li><p>filter()：返回满足条件的数据。</p></li>
<li><p>exclude()：返回满足条件之外的数据。</p></li>
<li><p>order_by()：对结果进行排序。</p></li>
</ul>
</li>
<li><p>对查询集可以再次调用过滤器进行过滤，如</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">BookInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">bread__gt</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;bpub_date&#39;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>也就意味着查询集可以含有零个、一个或多个过滤器。过滤器基于所给的参数限制查询的结果。</p></li>
<li><p>从SQL的角度讲，查询集与select语句等价，过滤器像where、limit、order by子句。</p></li>
<li><p>判断某一个查询集中是否有数据：</p></li>
<li><p>exists()：判断查询集中是否有数据，如果有则返回True，没有则返回False。</p></li>
</ul>
</li>
<li><p>两大特性</p>
<ul>
<li><p>惰性执行</p>
<ul class="simple">
<li><p>创建查询集不会访问数据库，直到调用数据时，才会访问数据库，调用数据的情况包括迭代、序列化、与if合用</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>例如，当执行如下语句时，并未进行数据库查询，只是创建了一个查询集qs
qs = BookInfo.objects.all()
继续执行遍历迭代操作后，才真正的进行了数据库的查询
for book in qs:
	print(book.btitle)
</pre></div>
</div>
</li>
<li><p>缓存</p>
<ul class="simple">
<li><p>使用同一个查询集，第一次使用时会发生数据库的查询，然后Django会把结果缓存下来，再次使用这个查询集时会使用缓存的数据，减少了数据库的查询次数。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>情况一：如下是两个查询集，无法重用缓存，每次查询都会与数据库进行一次交互，增加了数据库的负载。
from booktest.models import BookInfo
[book.id for book in BookInfo.objects.all()]
[book.id for book in BookInfo.objects.all()]
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>情况二：经过存储后，可以重用查询集，第二次使用缓存中的数据。

qs=BookInfo.objects.all()
[book.id for book in qs]
[book.id for book in qs]
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>限制查询集</p>
<ul class="simple">
<li><p>可以对查询集进行取下标或切片操作，等同于sql中的limit和offset子句。</p></li>
<li><p>注意：不支持负数索引。</p></li>
<li><p>对查询集进行切片后返回一个新的查询集，不会立即执行查询。</p></li>
<li><p>如果获取一个对象，直接使用[0]，等同于[0:1].get()，但是如果没有数据，[0]引发IndexError异常，[0:1].get()如果没有数据引发DoesNotExist异常。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>示例：获取第1、2项，运行查看。
qs = BookInfo.objects.all()[0:2]
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>管理器Manager</p>
<ul>
<li><p>管理器是Django的模型进行数据库操作的接口，Django应用的每个模型类都拥有至少一个管理器。</p></li>
<li><p>我们在通过模型类的objects属性提供的方法操作数据库时，即是在使用一个管理器对象objects。当没有为模型类定义管理器时，Django会为每一个模型类生成一个名为objects的管理器，它是models.Manager类的对象。</p></li>
<li><p>我们可以自定义管理器，并应用到我们的模型类上。</p></li>
<li><p>注意：一旦为模型类指明自定义的过滤器后，Django不再生成默认管理对象objects。</p></li>
<li><p>自定义管理器类主要用于两种情况：</p>
<ul>
<li><p>修改原始查询集，重写all()方法。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>打开booktest/models.py文件，定义类BookInfoManager

#图书管理器
class BookInfoManager(models.Manager):
	def all(self):
		#默认查询未删除的图书信息
		#调用父类的成员语法为：super().方法名
		return super().filter(is_delete=False)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">在模型类BookInfo中定义管理器</span>

<span class="k">class</span> <span class="nc">BookInfo</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
	<span class="o">...</span>
	<span class="n">books</span> <span class="o">=</span> <span class="n">BookInfoManager</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">使用方法</span>

<span class="n">BookInfo</span><span class="o">.</span><span class="n">books</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p>在管理器类中补充定义新的方法</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>打开booktest/models.py文件，定义方法create。
class BookInfoManager(models.Manager):
    #创建模型类，接收参数为属性赋值
    def create_book(self, title, pub_date):
        #创建模型类对象self.model可以获得模型类
        book = self.model()
        book.btitle = title
        book.bpub_date = pub_date
        book.bread=0
        book.bcommet=0
        book.is_delete = False
        # 将数据插入进数据表
        book.save()
        return book
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">为模型类BookInfo定义管理器books语法如下</span>
<span class="k">class</span> <span class="nc">BookInfo</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
      <span class="o">...</span>
    <span class="n">books</span> <span class="o">=</span> <span class="n">BookInfoManager</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>调用语法如下：
book=BookInfo.books.create_book(&quot;abc&quot;,date(1980,1,1))
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
</li>
</ol>
</section>
<section id="admin">
<h2>admin站点<a class="headerlink" href="#admin" title="永久链接至标题">¶</a></h2>
<ol>
<li><p>使用Admin站点</p>
<ul>
<li><p>假设我们要设计一个新闻网站，我们需要编写展示给用户的页面，网页上展示的新闻信息是从哪里来的呢？是从数据库中查找到新闻的信息，然后把它展示在页面上。但是我们的网站上的新闻每天都要更新，这就意味着对数据库的增、删、改、查操作，那么我们需要每天写sql语句操作数据库吗? 如果这样的话，是不是非常繁琐，所以我们可以设计一个页面，通过对这个页面的操作来实现对新闻数据库的增删改查操作。那么问题来了，老板说我们需要在建立一个新网站，是不是还要设计一个页面来实现对新网站数据库的增删改查操作，但是这样的页面具有一个很大的重复性，那有没有一种方法能够让我们很快的生成管理数据库表的页面呢？有，那就是我们接下来要给大家讲的Django的后台管理。Django能够根据定义的模型类自动地生成管理页面。</p></li>
<li><p>管理界面本地化</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">在settings</span><span class="o">.</span><span class="n">py中设置语言和时区</span>
<span class="n">LANGUAGE_CODE</span> <span class="o">=</span> <span class="s1">&#39;zh-hans&#39;</span> <span class="c1"># 使用中国语言</span>
<span class="n">TIME_ZONE</span> <span class="o">=</span> <span class="s1">&#39;Asia/Shanghai&#39;</span> <span class="c1"># 使用中国上海时间</span>
</pre></div>
</div>
</li>
<li><p>创建管理员</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>创建管理员的命令如下，按提示输入用户名、邮箱、密码。
python manage.py createsuperuser
打开浏览器，在地址栏中输入如下地址后回车。
http://127.0.0.1:8000/admin/
输入前面创建的用户名、密码完成登录。
如果想要修改密码可以执行
python manage.py changepassword 用户名
</pre></div>
</div>
</li>
<li><p>App应用配置</p>
<ul>
<li><p>在每个应用目录中都包含了apps.py文件，用于保存该应用的相关信息。</p></li>
<li><p>在创建应用时，Django会向apps.py文件中写入一个该应用的配置类，如</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.apps</span> <span class="kn">import</span> <span class="n">AppConfig</span>
<span class="k">class</span> <span class="nc">BooktestConfig</span><span class="p">(</span><span class="n">AppConfig</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;booktest&#39;</span>
</pre></div>
</div>
</li>
<li><p>我们将此类添加到工程settings.py中的INSTALLED_APPS列表中，表明注册安装具备此配置属性的应用</p>
<ul class="simple">
<li><p>AppConfig.name 属性表示这个配置类是加载到哪个应用的，每个配置类必须包含此属性，默认自动生成。</p></li>
<li><p>AppConfig.verbose_name 属性用于设置该应用的直观可读的名字，此名字在Django提供的Admin管理站点中会显示，如</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.apps</span> <span class="kn">import</span> <span class="n">AppConfig</span>

<span class="k">class</span> <span class="nc">BooktestConfig</span><span class="p">(</span><span class="n">AppConfig</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;booktest&#39;</span>
    <span class="n">verbose_name</span> <span class="o">=</span> <span class="s1">&#39;图书管理&#39;</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>注册模型类</p>
<ul class="simple">
<li><p>登录后台管理后，默认没有我们创建的应用中定义的模型类，需要在自己应用中的admin.py文件中注册，才可以在后台管理中看到，并进行增删改查操作。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>打开booktest/admin.py文件，编写如下代码：

from django.contrib import admin
from booktest.models import BookInfo,HeroInfo
admin.site.register(BookInfo)
admin.site.register(HeroInfo)
</pre></div>
</div>
</li>
<li><p>调整站点信息</p>
<ul class="simple">
<li><p>admin.site.site_header 设置网站页头</p></li>
<li><p>admin.site.site_title 设置页面标题</p></li>
<li><p>admin.site.index_title 设置首页标语</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">在booktest</span><span class="o">/</span><span class="n">admin</span><span class="o">.</span><span class="n">py文件中添加一下信息</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">site_header</span> <span class="o">=</span> <span class="s1">&#39;传智书城&#39;</span>
<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">site_title</span> <span class="o">=</span> <span class="s1">&#39;传智书城MIS&#39;</span>
<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">index_title</span> <span class="o">=</span> <span class="s1">&#39;欢迎使用传智书城MIS&#39;</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>调整列表页展示</p>
<ul class="simple">
<li><p>调整列表页和编辑页必须先—定义与使用Admin管理类</p></li>
<li><p>Django提供的Admin站点的展示效果可以通过自定义ModelAdmin类来进行控制</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>定义管理类需要继承自admin.ModelAdmin类，如下

from django.contrib import admin

class BookInfoAdmin(admin.ModelAdmin):
    pass
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>使用管理类有两种方式：
注册参数
admin.site.register(BookInfo,BookInfoAdmin)
装饰器
@admin.register(BookInfo)
class BookInfoAdmin(admin.ModelAdmin):
    pass
</pre></div>
</div>
<ul class="simple">
<li><p>列表中的列显示哪些字段</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>属性如下：
list_display=[模型字段1,模型字段2,...]
打开booktest/admin.py文件，修改BookInfoAdmin类如下：
class BookInfoAdmin(admin.ModelAdmin):
    ...
    list_display = [&#39;id&#39;,&#39;btitle&#39;]
</pre></div>
</div>
<ul class="simple">
<li><p>页大小</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>每页中显示多少条数据，默认为每页显示100条数据，属性如下：
list_per_page=100
打开booktest/admin.py文件，修改AreaAdmin类如下：
class BookInfoAdmin(admin.ModelAdmin):
    list_per_page = 2
</pre></div>
</div>
<ul>
<li><p>“操作选项”的位置</p>
<ul class="simple">
<li><p>顶部显示的属性，设置为True在顶部显示，设置为False不在顶部显示，默认为True。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">actions_on_top</span><span class="o">=</span><span class="kc">True</span>
</pre></div>
</div>
<ul class="simple">
<li><p>底部显示的属性，设置为True在底部显示，设置为False不在底部显示，默认为False。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">actions_on_bottom</span><span class="o">=</span><span class="kc">False</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>打开booktest/admin.py文件，修改BookInfoAdmin类如下：

class BookInfoAdmin(admin.ModelAdmin):
	...
	actions_on_top = True
	actions_on_bottom = True
</pre></div>
</div>
</li>
<li><p>右侧栏过滤器</p>
<ul class="simple">
<li><p>属性如下，只能接收字段，会将对应字段的值列出来，用于快速过滤。一般用于有重复值的字段。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>list_filter=[]
打开booktest/admin.py文件，修改HeroInfoAdmin类如下：
class HeroInfoAdmin(admin.ModelAdmin):
	...
	list_filter = [&#39;hbook&#39;, &#39;hgender&#39;]
</pre></div>
</div>
</li>
<li><p>搜索框</p>
<ul class="simple">
<li><p>属性如下，用于对指定字段的值进行搜索，支持模糊查询。列表类型，表示在这些字段上进行搜索。</p></li>
<li><p>search_fields=[]</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>打开booktest/admin.py文件，修改HeroInfoAdmin类如下：
class HeroInfoAdmin(admin.ModelAdmin):
	...
	search_fields = [&#39;hname&#39;]
</pre></div>
</div>
</li>
<li><p>将方法作为列</p>
<ul class="simple">
<li><p>列可以是模型字段，还可以是模型方法，要求方法有返回值。</p></li>
<li><p>通过设置short_description属性，可以设置在admin站点中显示的列名</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>打开booktest/models.py文件，修改BookInfo类如下：

class BookInfo(models.Model):
	...
	def pub_date(self):
		return self.bpub_date.strftime(&#39;%Y年%m月%d日&#39;)

	pub_date.short_description = &#39;发布日期&#39;  # 设置方法字段在admin中显示的标题
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>打开booktest/admin.py文件，修改BookInfoAdmin类如下：

class BookInfoAdmin(admin.ModelAdmin):
	...
	list_display = [&#39;id&#39;,&#39;atitle&#39;,&#39;pub_date&#39;]
</pre></div>
</div>
<ul class="simple">
<li><p>方法列是不能排序的，如果需要排序需要为方法指定排序依据。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>admin_order_field=模型类字段
打开booktest/models.py文件，修改BookInfo类如下：
class BookInfo(models.Model):
	...
	def pub_date(self):
		return self.bpub_date.strftime(&#39;%Y年%m月%d日&#39;)
	pub_date.short_description = &#39;发布日期&#39;
	pub_date.admin_order_field = &#39;bpub_date&#39;
</pre></div>
</div>
</li>
<li><p>关联对象</p>
<ul class="simple">
<li><p>无法直接访问关联对象的属性或方法，可以在模型类中封装方法，访问关联对象的成员</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>打开booktest/models.py文件，修改HeroInfo类如下：

class HeroInfo(models.Model):
	...
	def read(self):
		return self.hbook.bread

	read.short_description = &#39;图书阅读量&#39;
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>打开booktest/admin.py文件，修改HeroInfoAdmin类如下：

class HeroInfoAdmin(admin.ModelAdmin):
	...
	list_display = [&#39;id&#39;, &#39;hname&#39;, &#39;hbook&#39;, &#39;read&#39;]
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>调整编辑页展示</p>
<ul class="simple">
<li><p>显示字段</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>属性如下：
fields=[]

打开booktest/admin.py文件，修改BookInfoAdmin类如下：
class BookInfoAdmin(admin.ModelAdmin):
    ...
    fields = [&#39;btitle&#39;, &#39;bpub_date&#39;]
</pre></div>
</div>
<ul class="simple">
<li><p>分组显示</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>属性如下：
fieldsets=(
    (&#39;组1标题&#39;,{&#39;fields&#39;:(&#39;字段1&#39;,&#39;字段2&#39;)}),
    (&#39;组2标题&#39;,{&#39;fields&#39;:(&#39;字段3&#39;,&#39;字段4&#39;)}),
)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>打开booktest/admin.py文件，修改BookInfoAdmin类如下：
class BookInfoAdmin(admin.ModelAdmin):
    ...
    # fields = [&#39;btitle&#39;, &#39;bpub_date&#39;]
    fieldsets = (
        (&#39;基本&#39;, {&#39;fields&#39;: [&#39;btitle&#39;, &#39;bpub_date&#39;]}),
        (&#39;高级&#39;, {
            &#39;fields&#39;: [&#39;bread&#39;, &#39;bcomment&#39;],
            &#39;classes&#39;: (&#39;collapse&#39;,)  # 是否折叠显示
        })
    )
说明：fields与fieldsets两者选一使用。
</pre></div>
</div>
<ul class="simple">
<li><p>关联对象</p></li>
<li><p>在一对多的关系中，可以在一端的编辑页面中编辑多端的对象，嵌入多端对象的方式包括表格、块两种。</p>
<ul>
<li><p>类型InlineModelAdmin：表示在模型的编辑页面嵌入关联模型的编辑。</p></li>
<li><p>子类TabularInline：以表格的形式嵌入。</p></li>
<li><p>子类StackedInline：以块的形式嵌入。</p></li>
</ul>
</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>打开booktest/admin.py文件，创建HeroInfoStackInline类。

class HeroInfoStackInline(admin.StackedInline):
    model = HeroInfo  # 要编辑的对象
    extra = 1  # 附加编辑的数量
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>打开booktest/admin.py文件，修改BookInfoAdmin类如下：

class BookInfoAdmin(admin.ModelAdmin):
    ...
    inlines = [HeroInfoStackInline]
</pre></div>
</div>
<ul class="simple">
<li><p>可以用表格的形式嵌入。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>打开booktest/admin.py文件，创建HeroInfoTabularInline类。

class HeroInfoTabularInline(admin.TabularInline):
    model = HeroInfo
    extra = 1
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>打开booktest/admin.py文件，修改BookInfoAdmin类如下：

class BookInfoAdmin(admin.ModelAdmin):
    ...
    inlines = [HeroInfoTabularInline]
</pre></div>
</div>
</li>
<li><p>上传图片</p>
<ul class="simple">
<li><p>Django有提供文件系统支持，在Admin站点中可以轻松上传图片。</p></li>
<li><p>使用Admin站点保存图片，需要安装Python的图片操作包</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">Pillow</span>
</pre></div>
</div>
<ul>
<li><p>配置</p>
<ul class="simple">
<li><p>默认情况下，Django会将上传的图片保存在本地服务器上，需要配置保存的路径。</p></li>
<li><p>我们可以将上传的文件保存在静态文件目录中，如我们之前设置的static_files目录中在settings.py 文件中添加如下上传保存目录信息</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MEDIA_ROOT</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span><span class="s2">&quot;static_files/media&quot;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>为模型类添加ImageField字段</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">我们为之前的BookInfo模型类添加一个ImageFiled</span>

<span class="k">class</span> <span class="nc">BookInfo</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ImageField</span><span class="p">(</span><span class="n">upload_to</span><span class="o">=</span><span class="s1">&#39;booktest&#39;</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s1">&#39;图片&#39;</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">upload_to</span> <span class="n">选项指明该字段的图片保存在MEDIA_ROOT目录中的哪个子目录</span>
<span class="n">进行数据库迁移操作</span>

<span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">makemigrations</span>
<span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">migrate</span>
</pre></div>
</div>
</li>
<li><p>使用Admin站点上传图片</p>
<ul class="simple">
<li><p>进入Admin站点的图书管理页面，选择一个图书，能发现多出来一个上传图片的字段</p></li>
</ul>
</li>
</ul>
</li>
</ol>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Web框架" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Django%20REST%20framework.html" class="btn btn-neutral float-right" title="Django REST framework" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2022, Liulinyuan.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>